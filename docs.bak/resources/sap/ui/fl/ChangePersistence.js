/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/Change","sap/ui/fl/Layer","sap/ui/fl/Variant","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/Cache","sap/ui/fl/registry/Settings","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/write/_internal/Storage","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/model/json/JSONModel","sap/ui/performance/Measurement","sap/ui/thirdparty/jquery","sap/base/util/includes","sap/base/util/merge","sap/base/util/UriParameters","sap/base/Log","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/write/_internal/flexState/compVariants/CompVariantState","sap/ui/fl/write/_internal/condenser/Condenser"],function(e,t,n,r,i,a,s,o,h,g,p,f,c,l,u,d,C,m,y,_,v,D,S,b){"use strict";var I=function(t){this._mComponent=t;this._mChanges=e.createEmptyDependencyMap();this._bChangesMapCreated=false;this._mChangesInitial=m({},this._mChanges);if(!this._mComponent||!this._mComponent.name){_.error("The Control does not belong to an SAPUI5 component. Personalization and changes for this control might not work as expected.");throw new Error("Missing component name.")}this._aDirtyChanges=[];this._oMessagebundle=undefined;this._mChangesEntries={};this._bHasChangesOverMaxLayer=false;this.HIGHER_LAYER_CHANGES_EXIST="higher_layer_changes_exist"};function M(e,t){return e.controlChanges.some(function(n,r){if(n.fileName===t.getDefinition().fileName){e.controlChanges.splice(r,1,t);return true}})}function E(e,t){var r;if(t instanceof n){r=t;this._mChangesEntries[r.getFileName()]=r}else{if(!this._mChangesEntries[t.fileName]){this._mChangesEntries[t.fileName]=new n(t)}r=this._mChangesEntries[t.fileName];r.setState(n.states.PERSISTED);var i=r.getVariantReference();if(i){var a=v.getVariantManagementReferences(this._mComponent.name);a.some(function(e){var t=v.getVariant({vReference:i,vmReference:e,reference:this._mComponent.name});if(t){M(t,r);return true}return false}.bind(this))}}return r}I.prototype.getComponentName=function(){return this._mComponent.name};I.prototype.getCacheKey=function(e){return o.getCacheKey(this._mComponent,e)};I.prototype._preconditionsFulfilled=function(e){var t=e instanceof n?e.getDefinition():e;function r(){if(t.fileType==="ctrl_variant"||t.fileType==="ctrl_variant_change"||t.fileType==="ctrl_variant_management_change"){return t.variantManagementReference||t.variantReference||t.selector&&t.selector.id}}return t.fileType==="change"||r()};I.prototype.getChangesForComponent=function(e,n){return o.getChangesFillingCache(this._mComponent,e,n).then(function(e,n){var i=m({},n);var o=e&&e.component&&a.getAppComponentForControl(e.component);var h=t.isStorageResponseFilled(i.changes);if(!h){return[]}var g=i.changes.changes;if(!this._oMessagebundle&&i.messagebundle&&o){if(!o.getModel("i18nFlexVendor")){if(g.some(function(e){return e.layer===r.VENDOR})){this._oMessagebundle=i.messagebundle;var p=new l(this._oMessagebundle);o.setModel(p,"i18nFlexVendor")}}}var f=e&&e.currentLayer;var c=!(e&&e.ignoreMaxLayerParameter);var u=function(){return true};if(f){g=s.filterChangeOrChangeDefinitionsByCurrentLayer(g,f)}else if(s.isLayerFilteringRequired()&&c){u=this._filterChangeForMaxLayer.bind(this);g=g.filter(u)}else if(this._bHasChangesOverMaxLayer&&!c){this._bHasChangesOverMaxLayer=false;return this.HIGHER_LAYER_CHANGES_EXIST}var d=i.changes&&e&&e.includeCtrlVariants;var C=this._getAllCtrlVariantChanges(i,d,u);g=g.concat(C);return this._checkAndGetChangeInstances(g,i)}.bind(this,e))};I.prototype._checkAndGetChangeInstances=function(e,t){return e.filter(this._preconditionsFulfilled).map(E.bind(this,t))};I.prototype._filterChangeForMaxLayer=function(e){if(s.isOverMaxLayer(this._getLayerFromChangeOrChangeContent(e))){if(!this._bHasChangesOverMaxLayer){this._bHasChangesOverMaxLayer=true}return false}return true};I.prototype._getLayerFromChangeOrChangeContent=function(e){var t;if(e instanceof i||e instanceof n){t=e.getLayer()}else{t=e.layer}return t};I.prototype._getAllCtrlVariantChanges=function(e,t,n){if(!t){return v.getInitialChanges({reference:this._mComponent.name})}return["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"].reduce(function(t,n){if(e.changes[n]){return t.concat(e.changes[n])}return t},[]).filter(n)};I.prototype.loadChangesMapForComponent=function(t){return this.getChangesForComponent({component:t}).then(n.bind(this));function n(n){u.start("fl.createDependencyMap","Measurement of creating initial dependency map");this._mChanges=e.createEmptyDependencyMap();n.forEach(this.addChangeAndUpdateDependencies.bind(this,t));this._mChangesInitial=m({},this._mChanges);u.end("fl.createDependencyMap","Measurement of creating initial dependency map");this._bChangesMapCreated=true;return this.getChangesMapForComponent.bind(this)}};I.prototype.checkForOpenDependenciesForControl=function(t,n){return e.checkForOpenDependenciesForControl(this._mChanges,f.getControlIdBySelector(t,n),n)};I.prototype.copyDependenciesFromInitialChangesMap=function(e,t,n){var r=m({},this._mChangesInitial.mDependencies);var i=r[e.getId()];if(i){var a=[];i.dependencies.forEach(function(n){if(t(n)){this._mChanges.mDependentChangesOnMe[n]=this._mChanges.mDependentChangesOnMe[n]||[];this._mChanges.mDependentChangesOnMe[n].push(e.getId());a.push(n)}}.bind(this));var s;var o=[];i.controlsDependencies.forEach(function(t){if(!f.bySelector(t,n)){s=f.getControlIdBySelector(t,n);o.push(t);this._mChanges.mControlsWithDependencies[s]=this._mChanges.mControlsWithDependencies[s]||[];if(!C(this._mChanges.mControlsWithDependencies[s],e.getId())){this._mChanges.mControlsWithDependencies[s].push(e.getId())}}}.bind(this));i.dependencies=a;i.controlsDependencies=o;if(a.length||o.length){this._mChanges.mDependencies[e.getId()]=i}}return this._mChanges};I.prototype.addChangeAndUpdateDependencies=function(t,n,r){n.setInitialApplyState();if(r){e.insertChange(n,this._mChanges,r)}e.addChangeAndUpdateDependencies(n,t,this._mChanges)};I.prototype._addRunTimeCreatedChangeAndUpdateDependencies=function(t,n){e.addRuntimeChangeAndUpdateDependencies(n,t,this._mChanges,this._mChangesInitial)};I.prototype.getChangesMapForComponent=function(){return this._mChanges};I.prototype.isChangeMapCreated=function(){return this._bChangesMapCreated};I.prototype.changesHavingCorrectViewPrefix=function(e,t){var n=e.modifier;var r=e.appComponent;var i=t.getSelector();if(!i||!e){return false}if(i.viewSelector){var a=n.getControlIdBySelector(i.viewSelector,r);return a===e.viewId}var s=i.id;if(s){var o;if(t.getSelector().idIsLocal){if(r){o=r.getLocalId(e.viewId)}}else{o=e.viewId}var h=0;var g;do{h=s.indexOf("--",h);g=s.slice(0,h);h++}while(g!==o&&h>0);return g===o}return false};I.prototype.getChangesForView=function(e){return this.getChangesForComponent(e).then(function(t){return t.filter(this.changesHavingCorrectViewPrefix.bind(this,e))}.bind(this))};I.prototype.addChange=function(e,t){var n=this.addDirtyChange(e);this._addRunTimeCreatedChangeAndUpdateDependencies(t,n);this._mChangesEntries[n.getFileName()]=n;this._addPropagationListener(t);return n};I.prototype.addDirtyChange=function(e){var t;if(e instanceof n||e instanceof i){t=e}else{t=new n(e)}if(this._aDirtyChanges.indexOf(t)===-1){this._aDirtyChanges.push(t)}return t};I.prototype._addPropagationListener=function(e){var t=a.getAppComponentForControl(e);if(t instanceof c){var n=function(e){return!e._bIsSapUiFlFlexControllerApplyChangesOnControl};var r=t.getPropagationListeners().every(n);if(r){var i=sap.ui.require("sap/ui/fl/FlexControllerFactory");var s=i.create(this.getComponentName());var o=g.applyAllChangesForControl.bind(g,this.getChangesMapForComponent.bind(this),t,s);o._bIsSapUiFlFlexControllerApplyChangesOnControl=true;t.addPropagationListener(o)}}};I.prototype._deleteNotSavedChanges=function(e,t,n){e.filter(function(e){return!t.some(function(t){return e.getId()===t.getId()})}).forEach(function(e){if(n){this.removeChange(e)}else{this.deleteChange(e)}}.bind(this))};function F(e,t){var n=e.map(function(e){return e[t]()});var r=n.filter(function(e,t,n){return n.indexOf(e)===t});return r.length===1}function A(e,t){var n=false;if(!e||t.length<2){return false}if(!F(t,"getLayer")){return false}var r=t[0].getLayer();if(r==="CUSTOMER"||r==="USER"){n=true}var i=y.fromURL(window.location.href);if(i.has("sap-ui-xx-condense-changes")){n=i.get("sap-ui-xx-condense-changes")==="true"}return n}function L(e){var t=h.getInstanceOrUndef()&&h.getInstanceOrUndef().isCondensingEnabled();if(t&&!F(e,"getNamespace")){t=false}return t}function x(e,t,n,r){this._massUpdateCacheAndDirtyState(t,n);this._deleteNotSavedChanges(e,t,r)}function O(e){if(!e.length){return[]}var t=e[0].getLayer();var r=this._mChanges.aChanges.filter(function(e){return e.getState()===n.states.PERSISTED&&s.compareAgainstCurrentLayer(e.getLayer(),t)===0});return r.concat(e)}I.prototype.saveDirtyChanges=function(e,t,r,i){var a=r||this._aDirtyChanges;var s=O.call(this,a);var o=L(s)&&A(e,s);var h=o?s:a;var g=h.slice(0);var f=a.slice(0);var c=this._getRequests(a);var l=this._getPendingActions(a);if(l.length===1&&c.length===1&&l[0]===n.states.NEW){var u=Promise.resolve(g);if(A(e,g)){u=b.condense(e,g)}return u.then(function(e){var n=c[0];var r=a[0].getDefinition().layer;if(o){return p.condense({allChanges:h,condensedChanges:e,layer:r,transport:n,isLegacyVariant:false,parentVersion:i}).then(function(n){x.call(this,h,e,t,true);return n}.bind(this))}if(e.length){return p.write({layer:r,flexObjects:this._prepareDirtyChanges(e),transport:n,isLegacyVariant:false,parentVersion:i}).then(function(n){x.call(this,h,e,t);return n}.bind(this))}this._deleteNotSavedChanges(h,e)}.bind(this))}return this.saveSequenceOfDirtyChanges(f,t,i)};I.prototype.saveSequenceOfDirtyChanges=function(e,t,n){var r;if(n){var i=e.filter(function(e){return e.getPendingAction()==="NEW"});r=[].concat(i).shift()}return e.reduce(function(e,i){return e.then(this._performSingleSaveAction(i,r,n)).then(this._updateCacheAndDirtyState.bind(this,i,t))}.bind(this),Promise.resolve())};I.prototype._performSingleSaveAction=function(e,t,n){return function(){if(e.getPendingAction()==="NEW"){if(n!==undefined){n=e===t?n:sap.ui.fl.Versions.Draft}return p.write({layer:e.getLayer(),flexObjects:[e.getDefinition()],transport:e.getRequest(),parentVersion:n})}if(e.getPendingAction()==="DELETE"){return p.remove({flexObject:e.getDefinition(),layer:e.getLayer(),transport:e.getRequest()})}}};I.prototype._updateCacheAndDirtyState=function(e,t){if(!t){if(a.isChangeRelatedToVariants(e)){v.updateVariantsState({reference:this._mComponent.name,changeToBeAddedOrDeleted:e})}else if(a.isChangeRelatedToCompVariant(e)){S.updateState({reference:this._mComponent.name,changeToBeAddedOrDeleted:e})}else if(e.getPendingAction()===n.states.NEW){o.addChange(this._mComponent,e.getDefinition())}else if(e.getPendingAction()===n.states.DELETED){o.deleteChange(this._mComponent,e.getDefinition())}else if(e.getPendingAction()===n.states.DIRTY){o.updateChange(this._mComponent,e.getDefinition())}}this._aDirtyChanges=this._aDirtyChanges.filter(function(t){return e.getId()!==t.getId()})};I.prototype._massUpdateCacheAndDirtyState=function(e,t){e.forEach(function(e){this._updateCacheAndDirtyState(e,t)},this)};I.prototype._getRequests=function(e){var t=[];e.forEach(function(e){var n=e.getRequest();if(t.indexOf(n)===-1){t.push(n)}});return t};I.prototype._getPendingActions=function(e){var t=[];e.forEach(function(e){var n=e.getPendingAction();if(t.indexOf(n)===-1){t.push(n)}});return t};I.prototype._prepareDirtyChanges=function(e){var t=[];e.forEach(function(e){t.push(e.getDefinition())});return t};I.prototype.getDirtyChanges=function(){return this._aDirtyChanges};I.prototype.deleteChange=function(e,t){var n=this._aDirtyChanges.indexOf(e);if(n>-1){if(e.getPendingAction()==="DELETE"){return}this._aDirtyChanges.splice(n,1);this._deleteChangeInMap(e,t);return}e.markForDeletion();this.addDirtyChange(e);this._deleteChangeInMap(e,t)};I.prototype.removeChange=function(e){var t=this._aDirtyChanges.indexOf(e);if(t>-1){this._aDirtyChanges.splice(t,1)}this._deleteChangeInMap(e)};I.prototype._deleteChangeInMap=function(t,n){var r=t.getId();e.removeChangeFromMap(this._mChanges,r);e.removeChangeFromDependencies(n?this._mChangesInitial:this._mChanges,r)};function R(e,t){return(t.getRequest()==="$TMP"||t.getRequest()==="")&&t.getLayer()===e}I.prototype.transportAllUIChanges=function(e,t,n,r){return Promise.all([this.getChangesForComponent({currentLayer:n,includeCtrlVariants:true}),D.getCompEntitiesByIdMap(this.getComponentName())]).then(function(i){var a=i[0];var s=i[1];var o=[];for(var h in s){o.push(s[h])}a=a.concat(o.filter(R.bind(this,n)));return p.publish({transportDialogSettings:{rootControl:e,styleClass:t},layer:n,reference:this.getComponentName(),localChanges:a,appVariantDescriptors:r})}.bind(this))};I.prototype._getChangesFromMapByNames=function(e){return this._mChanges.aChanges.filter(function(t){return e.indexOf(t.getFileName())!==-1})};I.prototype.removeDirtyChanges=function(e,t,n,r,i){if(!n){_.error("The selectorId must be provided");return Promise.reject("The selectorId must be provided")}var a=this._aDirtyChanges;var s=a.filter(function(a){var s=true;if(a.getLayer()!==e){return false}if(r&&a.getDefinition().support.generator!==r){return false}var o=a.getSelector();s=n.getId()===f.getControlIdBySelector(o,t);if(i){s=s&&i.indexOf(a.getChangeType())!==-1}return s});s.forEach(function(e){var t=a.indexOf(e);a.splice(t,1)});return Promise.resolve(s)};I.prototype.resetChanges=function(e,t,n,r){var i=n&&n.length>0;var a=r&&r.length>0;return this.getChangesForComponent({currentLayer:e,includeCtrlVariants:true}).then(function(s){var o={reference:this.getComponentName(),layer:e,changes:s};if(t){o.generator=t}if(i){o.selectorIds=n}if(a){o.changeTypes=r}return p.reset(o)}.bind(this)).then(function(e){var t=[];if(n||r){var i=[];if(e&&e.response&&e.response.length>0){e.response.forEach(function(e){i.push(e.fileName)})}o.removeChanges(this._mComponent,i);t=this._getChangesFromMapByNames(i)}return t}.bind(this))};I.prototype.getResetAndPublishInfo=function(e){return p.getFlexInfo(e)};return I},true);