/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log"],function(e){"use strict";var t={};t.SOURCE_ALIAS="source";t.TARGET_ALIAS="target";t.MOVED_ELEMENTS_ALIAS="movedElements";t._checkConditions=function(e,t,r,o){if(!e){throw new Error("No change instance")}var n=e.getContent();if(!n||!n.movedElements||n.movedElements.length===0){throw new Error("Change format invalid")}if(!n.source||!n.source.selector){throw new Error("No source supplied for move")}if(!n.target||!n.target.selector){throw new Error("No target supplied for move")}if(!t.bySelector(n.source.selector,o,r)){throw new Error("Move source parent not found")}if(!t.bySelector(n.target.selector,o,r)){throw new Error("Move target parent not found")}if(!n.source.selector.aggregation){throw new Error("No source aggregation supplied for move")}if(!n.target.selector.aggregation){throw new Error("No target aggregation supplied for move")}};t._getElementControlOrThrowError=function(e,t,r,o){if(!e.selector&&!e.id){throw new Error("Change format invalid - moveElements element has no id attribute")}if(typeof e.targetIndex!=="number"){throw new Error("Missing targetIndex for element with id '"+e.selector.id+"' in movedElements supplied")}var n=t.bySelector(e.selector||e.id,r,o);if(!n){throw new Error("Control to move was not found. Id: '"+e.selector.id+"'")}return n};t._checkCompleteChangeContentConditions=function(e){if(!e.movedElements){throw new Error("mSpecificChangeInfo.movedElements attribute required")}if(e.movedElements.length===0){throw new Error("MovedElements array is empty")}e.movedElements.forEach(function(e){if(!e.id){throw new Error("MovedControls element has no id attribute")}if(typeof e.sourceIndex!=="number"){throw new Error("SourceIndex attribute at MovedElements element is no number")}if(typeof e.targetIndex!=="number"){throw new Error("TargetIndex attribute at MovedElements element is no number")}})};t._getSpecificChangeInfo=function(e,t,r){delete t.source.publicAggregation;delete t.target.publicAggregation;var o=t.source.parent||e.bySelector(t.source.id,r);var n=t.target.parent||e.bySelector(t.target.id,r);var a=t.source.aggregation;var g=t.target.aggregation;var i={aggregation:t.source.aggregation,type:e.getControlType(o)};var s={aggregation:t.target.aggregation,type:e.getControlType(n)};var c={source:{id:o.getId(),aggregation:a,type:i.type,selector:e.getSelector(t.source.id,r,i)},target:{id:n.getId(),aggregation:g,type:s.type,selector:e.getSelector(t.target.id,r,s)},movedElements:t.movedElements};return c};t.applyChange=function(e,t,r){var o=r.modifier;var n=r.view;var a=r.appComponent;this._checkConditions(e,o,n,a);var g=e.getContent();var i=[];g.movedElements.forEach(function(e){var t=this._getElementControlOrThrowError(e,o,a,n);var s=o.getParent(t);var c=r.sourceAggregation||o.getParentAggregationName(t,s);var l=o.bySelector(g.target.selector,a,n);var d=r.targetAggregation||g.target.selector.aggregation;var u=o.findIndexInParentAggregation(t);var v=e.targetIndex;var m=false;if(u>-1){if(u===v&&c===d&&o.getParent(t)===l){u=e.sourceIndex;s=o.bySelector(g.source.selector,a,n);c=r.sourceAggregation||g.source.selector.aggregation;m=true}i.unshift({index:u,aggregation:c,sourceParent:o.getSelector(s,a)})}if(!m){o.removeAggregation(s,c,t);o.insertAggregation(l,d,t,v,n)}},this);e.setRevertData(i);return true};t.revertChange=function(t,r,o){var n=o.modifier;var a=o.view;var g=o.appComponent;this._checkConditions(t,n,a,g);var i=t.getContent();var s=n.bySelector(i.source.selector,g,a);var c=i.source.selector.aggregation;var l=n.bySelector(i.target.selector,g,a);var d=i.target.selector.aggregation;var u=t.getRevertData();t.getContent().movedElements.reverse();i.movedElements.forEach(function(t,r){var o=this._getElementControlOrThrowError(t,n,g,a);if(!o){e.warning("Element to move not found");return}var i=t.sourceIndex;if(u){var v=u[r];c=v.aggregation;i=v.index;s=n.bySelector(v.sourceParent,g,a)}n.removeAggregation(l,d,o);n.insertAggregation(s,c,o,i,a)},this);t.resetRevertData();return true};t.completeChangeContent=function(e,r,o){this._checkCompleteChangeContentConditions(r);var n=o.modifier;var a=o.appComponent;var g=e.getDefinition();r=this._getSpecificChangeInfo(n,r,a);g.content={movedElements:[],source:{selector:r.source.selector},target:{selector:r.target.selector}};r.movedElements.forEach(function(e){var t=e.element||n.bySelector(e.id,a);g.content.movedElements.push({selector:n.getSelector(t,a),sourceIndex:e.sourceIndex,targetIndex:e.targetIndex})});e.addDependentControl(r.source.id,t.SOURCE_ALIAS,o);e.addDependentControl(r.target.id,t.TARGET_ALIAS,o);e.addDependentControl(r.movedElements.map(function(e){return e.id}),t.MOVED_ELEMENTS_ALIAS,o)};t.getCondenserInfo=function(e){var t=e.getContent();var r=e.getRevertData()[0];return{affectedControl:t.movedElements[0].selector,classification:sap.ui.fl.condenser.Classification.Move,sourceContainer:r.sourceParent,targetContainer:t.target.selector,sourceIndex:r.index,sourceAggregation:r.aggregation,targetAggregation:t.target.selector.aggregation,setTargetIndex:function(e,t){e.getContent().movedElements[0].targetIndex=t},getTargetIndex:function(e){return e.getContent().movedElements[0].targetIndex}}};t.getChangeVisualizationInfo=function(e){var t=e.getContent();return{affectedControls:[t.movedElements[0].selector],dependentControls:[t.source.selector]}};return t},true);