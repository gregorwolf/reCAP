/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/core/Element","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/changes/FlexCustomData","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/Utils"],function(e,n,r,t,i,a,o){"use strict";var s=new o.FakePromise;function l(e,n){var r=e.getSelector&&e.getSelector();if(!r||!r.id&&!r.name){throw Error("No selector in change found or no selector ID.")}var t=n.modifier.bySelector(r,n.appComponent,n.view);if(!t){throw Error("A flexibility change tries to change a nonexistent control.")}var i=e.getDependentControlSelectorList();i.forEach(function(e){var r=n.modifier.bySelector(e,n.appComponent,n.view);if(!r){throw Error("A dependent selector control of the flexibility change is not available.")}});return t}function c(e,n,r,a,o){var s=f(o);var l=i.getControlIfTemplateAffected(n,e,o);var c=t.hasChangeApplyFinishedCustomData(l.control,n,o.modifier);var p=n.isApplyProcessFinished();if(p&&!c){if(!s){var g=i.checkIfDependencyIsStillValid.bind(null,o.appComponent,o.modifier,r);r=a._oChangePersistence.copyDependenciesFromInitialChangesMap(n,g,o.appComponent)}n.setInitialApplyState()}else if(!p&&c){n.markFinished()}return r}function p(e,n){var r;if(f(n)&&e.getDefinition().jsOnly){r="Change cannot be applied in XML. Retrying in JS."}if(r){e.setInitialApplyState();throw Error(r)}}function g(e,r,i,a){if(i instanceof n){r.control=i}if(r.control){a.modifier.updateAggregation(r.originalControl,e.getContent().boundAggregation)}t.addAppliedCustomData(r.control,e,a,f(a));var o={success:true};e.markFinished(o);return o}function d(e,n,r,i){var a=f(i);var s={success:false,error:e};var l=n.getId();var c="Change ''{0}'' could not be applied.";var p=e instanceof Error;var g=t.getCustomDataIdentifier(false,p,a);switch(g){case t.notApplicableChangesCustomDataKey:o.formatAndLogMessage("info",[c,e.message],[l]);break;case t.failedChangesCustomDataKeyXml:o.formatAndLogMessage("warning",[c,"Merge error detected while processing the XML tree."],[l],e.stack);break;case t.failedChangesCustomDataKeyJs:o.formatAndLogMessage("error",[c,"Merge error detected while processing the JS control tree."],[l],e.stack);break}t.addFailedCustomData(r.control,n,i,g);if(a){n.setInitialApplyState()}else{n.markFinished(s)}return s}function f(e){return e.modifier.targets==="xmlTree"}function u(n,r){var t=r.getDefinition();var i=t.changeType;var a=t.selector.id;var o=t.namespace+t.fileName+"."+t.fileType;var s="A flexibility change could not be applied.";s+="\nThe displayed UI might not be displayed as intedend.";if(n.message){s+="\n   occurred error message: '"+n.message+"'"}s+="\n   type of change: '"+i+"'";s+="\n   LRep location of the change: "+o;s+="\n   id of targeted control: '"+a+"'.";e.warning(s,undefined,"sap.ui.fl.apply._internal.changes.Applier")}function h(e,n,t){var i={appComponent:t,modifier:r};var a=r.bySelector(e.originalSelectorToBeAdjusted,t);var o=n.getBindingInfo(e.getContent().boundAggregation).template;if(a.getParent()){var s=[];var l=a;do{s.push({aggregation:l.sParentAggregationName,index:l.getParent().getAggregation(l.sParentAggregationName).indexOf(l)});l=l.getParent()}while(l.getParent());s.reverse();s.forEach(function(e){o=o.getAggregation(e.aggregation)[e.index]})}e.addDependentControl(o,"originalSelector",i)}var m={addPreConditionForInitialChangeApplying:function(e){s=s.then(function(){return e})},applyChangeOnControl:function(e,n,r){var t=i.getControlIfTemplateAffected(e,n,r);return i.getChangeHandler(e,t,r).then(function(n){p(e,r);return n}).then(function(n){if(e.hasApplyProcessStarted()){return e.addPromiseForApplyProcessing().then(function(n){e.markFinished();return n})}else if(!e.isApplyProcessFinished()){return(new o.FakePromise).then(function(){e.startApplying();return n.applyChange(e,t.control,r)}).then(function(n){return g(e,t,n,r)}).catch(function(n){return d(n,e,t,r)})}var i={success:true};e.markFinished(i);return i}).catch(function(e){return{success:false,error:e}})},applyAllChangesForControl:function(e,n,t,i){var l=e();var p=i.getId();var g=l.mChanges[p]||[];g.forEach(function(e){if(!e.isApplyProcessFinished()&&!e._ignoreOnce){e.setQueuedForApply()}});s=s.then(function(e){var i=[];var s=e.getId();var p=l.mChanges[s]||[];var g={modifier:r,appComponent:n,view:o.getViewForControl(e)};var d;if(l.mControlsWithDependencies[s]){a.removeControlsDependencies(l,s);d=true}p.forEach(function(r){if(r.originalSelectorToBeAdjusted){h(r,e,n);delete r.originalSelectorToBeAdjusted}l=c(e,r,l,t,g);if(r._ignoreOnce){delete r._ignoreOnce}else if(r.isApplyProcessFinished()){a.resolveDependenciesForChange(l,r.getId(),s)}else if(!l.mDependencies[r.getId()]){i.push(function(){return m.applyChangeOnControl(r,e,g).then(function(){a.resolveDependenciesForChange(l,r.getId(),s)})})}else{var o=m.applyChangeOnControl.bind(m,r,e,g);a.addChangeApplyCallbackToDependency(l,r.getId(),o)}});if(p.length||d){return o.execPromiseQueueSequentially(i).then(function(){return a.processDependentQueue(l,n,s)})}}.bind(null,i));return s},applyAllChangesForXMLView:function(n,r){if(!Array.isArray(r)){var t="No list of changes was passed for processing the flexibility on view: "+n.view+".";e.error(t,undefined,"sap.ui.fl.apply._internal.changes.Applier");r=[]}return r.reduce(function(e,r){return e.then(function(){var e=l(r,n);r.setQueuedForApply();c(e,r,undefined,undefined,n);if(!r.isApplyProcessFinished()){return m.applyChangeOnControl(r,e,n)}return{success:true}}).then(function(e){if(!e.success){throw Error(e.error)}}).catch(function(e){u(e,r)})},new o.FakePromise).then(function(){return n.view})}};return m},true);