/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/fl/apply/_internal/changes/FlexCustomData","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/Utils"],function(e,r,t,n){"use strict";function o(e){if(!e.isApplyProcessFinished()&&e.hasApplyProcessStarted()){return e.addPromiseForApplyProcessing().then(function(r){if(r&&r.error){e.markRevertFinished(r.error);throw Error(r.error)}})}}var i={revertChangeOnControl:function(n,i,a){var s=t.getControlIfTemplateAffected(n,i,a);var l;return t.getChangeHandler(n,s,a).then(function(e){l=e}).then(o.bind(null,n)).then(function(){if(n.isApplyProcessFinished()){if(!n.hasRevertData()){n.setRevertData(r.getParsedRevertDataFromCustomData(i,n,a.modifier))}n.startReverting();return l.revertChange(n,s.control,a)}throw Error("Change was never applied")}).then(function(){s.control=a.modifier.bySelector(n.getSelector(),a.appComponent,a.view);if(s.bTemplateAffected){a.modifier.updateAggregation(s.control,n.getContent().boundAggregation)}n.markRevertFinished();return s.control}).catch(function(r){var t="Change could not be reverted: "+r.message;e.error(t);n.markRevertFinished(t);return false})},revertMultipleChanges:function(t,o){var a=[];t.forEach(function(t){t.setQueuedForRevert();a.push(function(){var a=t.getSelector&&t.getSelector();var s=o.modifier.bySelector(a,o.appComponent);if(!s){e.warning("A flexibility change tries to revert changes on a nonexistent control with id "+a.id);return new n.FakePromise}var l={modifier:o.modifier,appComponent:o.appComponent,view:n.getViewForControl(s)};return i.revertChangeOnControl(t,s,l).then(function(e){r.destroyAppliedCustomData(e||s,t,o.modifier);return!!e}).then(function(e){if(e){o.flexController._oChangePersistence._deleteChangeInMap(t)}})})});return n.execPromiseQueueSequentially(a)}};return i},true);