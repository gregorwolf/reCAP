/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/ObjectPath","sap/base/Log","sap/ui/fl/Change","sap/base/util/includes","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/base/util/isEmptyObject","sap/base/util/each","sap/base/util/values","sap/base/util/merge","sap/ui/fl/LayerUtils"],function(e,n,t,a,r,i,c,o,s,u){"use strict";function f(e,n){var t=s({},e);n.forEach(function(e){t[e.fileName]={content:e,controlChanges:[],variantChanges:{}}});return t}function v(e,n){var t=s({},e);n.forEach(function(e){t[e.variantReference]=t[e.variantReference]||A(e.variantReference);t[e.variantReference].controlChanges.push(e)});return t}function l(e,n){var t=s({},e);n.forEach(function(e){t[e.selector.id]=t[e.selector.id]||A(e.selector.id);var n=t[e.selector.id].variantChanges[e.changeType]||[];n.push(e);t[e.selector.id].variantChanges[e.changeType]=n});return t}function g(n){var t=s({},n);o(n).forEach(function(n){var a=e.get("variantChanges.setVisible",n);if(a&&a.length>0){var r=M(a);if(!r.getContent().visible&&r.getContent().createdByReset){delete t[n.content.fileName]}}});return t}function h(e){var n=s({},e);o(n).forEach(function(e){var t=e.content.variantReference;var a;if(t){a=C(n,t,e.content.variantManagementReference)}e.controlChanges=p(a,e.content.layer).concat(e.controlChanges)});return n}function p(e,n){if(!e){return[]}return o(s({},e.controlChanges)).filter(function(e){return u.compareAgainstCurrentLayer(e.layer,n)===-1})}function C(e,n,t){var a=e[n];if(!a&&n===t){a=A(n);e[n]=a}return a}function b(e){var n={};n=f(n,e.variants);n=v(n,e.variantDependentControlChanges);n=l(n,e.variantChanges);n=g(n);n=h(n);return n}function m(){return{variantManagementChanges:{},variants:[]}}function R(e,n,t){var i=s({},e);o(n).forEach(function(e){var n=e.content.variantManagementReference;if(!i[n]){i[n]=m()}e=x(e);e=N(e);if(!i[n].currentVariant&&e.content.content.visible&&a(t,e.content.fileName)){i[n].currentVariant=e.content.fileName}i[n].defaultVariant=n;var c=r.getIndexToSortVariant(i[n].variants,e);i[n].variants.splice(c,0,e)});return i}function d(e,n){var t=s({},e);n.forEach(function(e){var n=e.selector.id;if(!t[n]){t[n]=m()}var a=e.changeType;if(!t[n].variantManagementChanges[a]){t[n].variantManagementChanges[a]=[]}t[n].variantManagementChanges[a].push(e);t[n]=y(t[n])});return t}function T(e){var n=s({},e);c(n,function(e,n){var t=n.variants.findIndex(function(n){return n.content.fileName===e});var a;if(t===-1){a=A(e)}else{a=n.variants[t];n.variants.splice(t,1)}n.variants.unshift(a)});return n}function E(e,n,t){var a={};a=R(a,e,t);a=d(a,n);a=T(a);return a}function A(e){var n=sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl");return{content:{fileName:e,variantManagementReference:e,variantReference:"",content:{title:n.getText("STANDARD_VARIANT_TITLE"),favorite:true,visible:true},support:{user:r.DEFAULT_AUTHOR}},variantChanges:{},controlChanges:[]}}function y(e){var n=s({},e);var t=n.variantManagementChanges;var a;if(!i(t)){a=M(t["setDefault"]);if(a){n.defaultVariant=a.getContent().defaultVariant}}return n}function N(e){var t=s({},e);var a=t.variantChanges;var r;c(a,function(e,a){switch(e){case"setTitle":r=M(a);if(r){t.content.content.title=r.getText("title")}break;case"setFavorite":r=M(a);if(r){t.content.content.favorite=r.getContent().favorite}break;case"setExecuteOnSelect":r=M(a);if(r){t.content.content.executeOnSelect=r.getContent().executeOnSelect}break;case"setVisible":r=M(a);if(r){t.content.content.visible=r.getContent().visible}break;default:n.error("No valid changes on variant "+t.content.content.title+" available")}});return t}function M(e){if(e.length>0){return new t(e[e.length-1])}return false}function V(e){return sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl").getText(e)}function x(n){var t=s({},n);if(t.content.fileName===t.content.variantManagementReference){if(!e.get("content.support.user",t)){var a={support:{user:r.DEFAULT_AUTHOR}};s(t.content,a)}}if(!t.content.content.favorite){t.content.content.favorite=true}if(!t.content.content.visible){t.content.content.visible=true}if(!t.content.content.executeOnSelect){t.content.content.executeOnSelect=false}var i=t.content.content.title.match(/.i18n>(\w+)./);if(i){t.content.content.title=V(i[1])}return t}return function(n){if(i(n)||!e.get("storageResponse.changes.variants",n)){return{}}var t=e.get(["technicalParameters",r.VARIANT_TECHNICAL_PARAMETER],n.componentData)||[];var a=b(n.storageResponse.changes);a=E(a,n.storageResponse.changes.variantManagementChanges,t);return a}});