/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/each","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/Component","sap/ui/fl/apply/_internal/flexState/appDescriptorChanges/prepareAppDescriptorMap","sap/ui/fl/apply/_internal/flexState/changes/prepareChangesMap","sap/ui/fl/apply/_internal/flexState/compVariants/prepareCompVariantsMap","sap/ui/fl/apply/_internal/flexState/controlVariants/prepareVariantsMap","sap/ui/fl/apply/_internal/flexState/Loader","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/LayerUtils","sap/ui/fl/Utils"],function(e,n,t,a,r,i,o,p,s,c,l,f,u,g){"use strict";var h={};var d={};var m={};var S={};var v={appDescriptorChanges:{prepareFunction:i,pathInResponse:[]},changes:{prepareFunction:o,pathInResponse:["changes"]},variants:{prepareFunction:s,pathInResponse:["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"]},compVariants:{prepareFunction:p,pathInResponse:["comp.variants","comp.standardVariants","comp.defaultVariants","comp.changes"]}};function R(e){var n=r.get(e.componentId);d[e.reference].componentData=n?n.getComponentData():e.componentData}function F(e){var n=r.get(e.componentId);e.componentData=e.componentData||n.getComponentData()||{};e.manifest=e.manifest||e.rawManifest||n.getManifestObject();e.reference=e.reference||l.getFlexReference(e)}function I(e,n){if(!d[e]){throw new Error("State is not yet initialized")}if(!d[e].preparedMaps[n]){var t={unfilteredStorageResponse:d[e].unfilteredStorageResponse,storageResponse:d[e].storageResponse,componentId:d[e].componentId,componentData:d[e].componentData};d[e].preparedMaps[n]=h.callPrepareFunction(n,t)}return d[e].preparedMaps[n]}function C(e){return I(e,"appDescriptorChanges")}function x(e){return I(e,"changes")}function D(e){return I(e,"variants")}function M(e){return I(e,"compVariants")}function y(e){if(e.reference.endsWith(".Component")){var t=e.reference.split(".");t.pop();var a=t.join(".");d[a]=n({},{storageResponse:{changes:f.getEmptyFlexDataResponse()},unfilteredStorageResponse:{changes:f.getEmptyFlexDataResponse()},preparedMaps:{},componentId:e.componentId,partialFlexState:e.partialFlexState});S[a]=S[e.reference]}}function b(a){var r=n({},a);var i=r.changes;if(u.isLayerFilteringRequired()){e(v,function(e,n){n.pathInResponse.forEach(function(e){t.set(e,u.filterChangeDefinitionsByMaxLayer(t.get(e,i)),i)})})}return r}function V(e){S[e.reference]=c.loadFlexData(e).then(function(t){d[e.reference]=n({},{unfilteredStorageResponse:t,preparedMaps:{},componentId:e.componentId,componentData:e.componentData,partialFlexState:e.partialFlexState});y(e);z(e.reference);return t});return S[e.reference]}function z(e){g.ifUShellContainerThen(function(n){m[e]=L.bind(null,e);n[0].registerNavigationFilter(m[e])},["ShellNavigation"])}function U(e){g.ifUShellContainerThen(function(n){if(m[e]){n[0].unregisterNavigationFilter(m[e]);delete m[e]}},["ShellNavigation"])}function L(e,n,t){return g.ifUShellContainerThen(function(r){try{var i=u.getMaxLayerTechnicalParameter(n);var o=u.getMaxLayerTechnicalParameter(t);if(i!==o){h.clearFilteredResponse(e)}}catch(e){a.error(e.message)}return r[0].NavigationFilterStatus.Continue},["ShellNavigation"])}function P(e){d[e].preparedMaps={}}function _(e){var t=d[e.reference];if(t.partialFlexState===true&&e.partialFlexState!==true){t.partialFlexState=false;e.partialFlexData=n({},t.unfilteredStorageResponse.changes);e.reInitialize=true}return e}function E(e){var n=d[e.reference].componentId;if(!e.reInitialize&&n!==e.componentId){e.reInitialize=true}return e}h.initialize=function(e){return Promise.resolve(e).then(function(e){F(e);var n=e.reference;if(S[n]){return S[n].then(_.bind(null,e)).then(E).then(function(e){return e.reInitialize?V(e):d[n].unfilteredStorageResponse})}return V(e)}).then(function(e,n){if(!d[e.reference].storageResponse){d[e.reference].storageResponse=b(n);R(e);h.getVariantsState(e.reference)}}.bind(null,e))};h.clearAndInitialize=function(e){F(e);var n=!!t.get(["preparedMaps","variantsMap"],d[e.reference]);h.clearState(e.reference);h.clearState(g.normalizeReference(e.reference));return h.initialize(e).then(function(e,n){if(e){return h.getVariantsState(n)}}.bind(null,n,e.reference))};h.clearState=function(e){if(e){U(e);delete d[e];delete S[e]}else{Object.keys(d).forEach(function(e){U(e)});d={};S={}}};h.clearFilteredResponse=function(e){if(d[e]){P(e);delete d[e].storageResponse}};h.getUIChanges=function(e){return x(e).changes};h.getAppDescriptorChanges=function(e){return C(e).appDescriptorChanges};h.getVariantsState=function(e){return D(e)};h.getUI2Personalization=function(e){return d[e].unfilteredStorageResponse.changes.ui2personalization};h.getCompVariantsMap=function(e){return M(e).map};h.getCompEntitiesByIdMap=function(e){return M(e).byId};h.callPrepareFunction=function(e,n){return v[e].prepareFunction(n)};h.getStorageResponse=function(e){if(S[e]){return S[e].then(function(){return d[e].unfilteredStorageResponse})}};h.getFlexObjectsFromStorageResponse=function(e){return d[e]&&d[e].unfilteredStorageResponse.changes};return h},true);