/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/registry/ChangeRegistry","sap/ui/fl/FlexControllerFactory","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Element","sap/ui/base/ManagedObject","sap/base/util/includes","sap/ui/fl/variants/VariantManagement","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/core/Component","sap/base/Log","sap/ui/thirdparty/jquery"],function(e,t,r,n,a,o,i,c,s,l,u,f,g,p,d){"use strict";var m={_determineParameters:function(e,t,n){var a=r.getAppComponentForControl(e);var i=o.createForControl(a);var c=a.getRootControl();var s={rootControl:c,flexController:i};if(!t){var l;var u;var f;s.variantModel=a.getModel(r.VARIANT_MODEL_NAME);s.variantManagement={};if(!n){l=d.makeArray(s.rootControl.$().find(".sapUiFlVarMngmt"))}if(n||l.length===0){l=d.makeArray(d(sap.ui.getCore().getStaticAreaRef()).find(".sapUiFlVarMngmt"))}l.map(function(e){u=sap.ui.getCore().byId(e.id);if(u.getMetadata().getName()==="sap.ui.fl.variants.VariantManagement"){f=u.getFor();f.forEach(function(t){s.variantManagement[t]=s.variantModel.getLocalId(e.id,a)})}})}return s},_getVariantManagement:function(e,t){t=t||this._determineParameters(e);var r=function(e){if(!t.variantManagement[e.getId()]&&e.getParent()&&e.getId()!==t.rootControl.getId()){return r(e.getParent())}else if(!e.getParent()||e.getId()===t.rootControl.getId()){return t.variantManagement[e.getId()]||""}return t.variantManagement[e.getId()]};return r(e)},clearVariantParameterInURL:function(e){var t;var n=r.getAppComponentForControl(e);var a=n instanceof g?n.getModel(r.VARIANT_MODEL_NAME):undefined;if(!a){p.warning("Variant model could not be found on the provided control")}if(e instanceof u){var o=a.getLocalId(e.getId(),n);var i=f.removeURLParameterForVariantManagement({model:a,vmReference:o});t=i.parameters}f.update({parameters:t||[],updateURL:true,updateHashEntry:!!a,model:a||{},silent:!a})},activateVariant:function(e,t){return Promise.resolve().then(function(){var n;if(typeof e==="string"||e instanceof String){n=g.get(e);if(!(n instanceof g)){n=sap.ui.getCore().byId(e);if(!(n instanceof c)){throw new Error("No valid component or control found for the provided ID")}}}else if(e instanceof g||e instanceof c){n=e}var a=r.getAppComponentForControl(n);if(!a){throw new Error("A valid variant management control or component (instance or ID) should be passed as parameter")}var o=a.getModel(r.VARIANT_MODEL_NAME);if(!o){throw new Error("No variant management model found for the passed control or application component")}var i=o.getVariantManagementReference(t).variantManagementReference;if(!i){throw new Error("A valid control or component, and a valid variant/ID combination are required")}return o.waitForVMControlInit(i).then(function(){return o.updateCurrentVariant({variantManagementReference:i,newVariantReference:t,appComponent:a})})})["catch"](function(e){p.error(e);return Promise.reject(e)})},_checkChangeSpecificData:function(e,t){if(!e.changeSpecificData){return Promise.reject(new Error("No changeSpecificData available"))}if(!e.changeSpecificData.changeType){return Promise.reject(new Error("No valid changeType"))}if(!(e.selectorControl instanceof c)){return Promise.reject(new Error("No valid selectorControl"))}var r=e.selectorControl.getMetadata().getName();var n=a.getInstance();return n.getChangeHandler(e.changeSpecificData.changeType,r,e.selectorControl,i,t)},addPersonalizationChanges:function(e){var n=[];var a=[];var o=t.USER;var i=[];function c(t,r){return m._checkChangeSpecificData(t,o).then(function(){e.params=m._determineParameters(t.selectorControl,e.ignoreVariantManagement,e.useStaticArea);if(!e.ignoreVariantManagement){if(!t.changeSpecificData.variantReference){var n=m._getVariantManagement(t.selectorControl,e.params);if(n){var a=e.params.variantModel.oData[n].currentVariant;t.changeSpecificData.variantReference=a}}}else{delete t.changeSpecificData.variantReference}return e.params.flexController.addChange(Object.assign(r,t.changeSpecificData),t.selectorControl)}).then(function(e){t.changeInstance=e;n.push(t)}).catch(function(e){return Promise.reject({change:t,message:e.message})})}function s(t){return e.params.flexController.applyChange(t.changeInstance,t.selectorControl).then(function(){a.push(t.changeInstance)}).catch(function(e){return Promise.reject({change:t,message:e.message})})}e.controlChanges.forEach(function(e){var t={};Object.assign(t,{developerMode:false,layer:o});i.push(c.bind(undefined,e,t))});return r.execPromiseQueueSequentially(i).then(function(){i=[];n.forEach(function(e){i.push(s.bind(undefined,e))});return r.execPromiseQueueSequentially(i)}).then(function(){return a})},isPersonalized:function(e,n){if(!e||e.length===0){return this._reject("At least one control ID has to be provided as a parameter")}var a=e[0].appComponent||r.getAppComponentForControl(e[0]);if(!a){return this._reject("App Component could not be determined")}var i=e.map(function(e){return e.id||e.getId()});var c=o.createForControl(a);return c.getComponentChanges({currentLayer:t.USER,includeCtrlVariants:true}).then(function(e){return e.filter(this._filterBySelectors.bind(this,a,i)).filter(this._filterByChangeType.bind(this,n)).some(this._ifValidFileType)}.bind(this))},_reject:function(e){p.error(e);return Promise.reject(e)},_filterBySelectors:function(e,t,r){var n=r.getSelector();var a=i.getControlIdBySelector(n,e);return l(t,a)},_filterByChangeType:function(e,t){return Array.isArray(e)&&e.length>0?l(e,t.getChangeType()):true},_ifValidFileType:function(e){return e.getFileType()==="change"},resetChanges:function(e,n){if(!e||e.length===0){return this._reject("At least one control ID has to be provided as a parameter")}var a=e[0].appComponent||r.getAppComponentForControl(e[0]);if(!a){return this._reject("App Component could not be determined")}var i=e.map(function(e){var t=e.id||e.getId();var r=a.getLocalId(t);return r||t});var c=o.createForControl(a);return c.resetChanges(t.USER,undefined,a,i,n)},saveChanges:function(e,t){if(!(t instanceof s)){var n="A valid sap.ui.base.ManagedObject instance is required as a parameter";p.error(n);return Promise.reject(n)}var a=m._determineParameters(t);var o=r.getAppComponentForControl(t);var i=Object.keys(a.variantManagement).reduce(function(e,t){return e.concat([a.variantManagement[t]])},[]);return a.flexController.saveSequenceOfDirtyChanges(e,o).then(function(e){a.variantModel.checkDirtyStateForControlModels(i);return e})},hasVariantManagement:function(e){try{return!!this._getVariantManagement(e)}catch(e){p.error(e.message);return false}}};return m},true);