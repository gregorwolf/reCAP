/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/registry/ChangeRegistry","sap/ui/fl/Utils","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/Change","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/write/_internal/Versions","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/util/reflection/XmlTreeModifier","sap/ui/core/Component","sap/base/Log"],function(e,t,n,r,o,i,a,s,p,h,c,g,u,l,f){"use strict";function C(e,n){return Promise.resolve().then(function(){if(n.length!==0){n.reverse();return h.revertMultipleChanges(n,{appComponent:e,modifier:g,flexController:this})}}.bind(this)).then(function(){if(e){var r=e.getModel(t.VARIANT_MODEL_NAME);if(r){n.forEach(function(e){var t=e.getVariantReference();if(t){r.removeChange(e)}});c.update({parameters:[],updateURL:true,updateHashEntry:true,model:r})}}return n})}var d=function(e){this._oChangePersistence=undefined;this._sComponentName=e||"";if(this._sComponentName){this._createChangePersistence()}};d.prototype.getComponentName=function(){return this._sComponentName};d.prototype.setVariantSwitchPromise=function(e){this._oVariantSwitchPromise=e};d.prototype.waitForVariantSwitch=function(){if(!this._oVariantSwitchPromise){this._oVariantSwitchPromise=Promise.resolve()}return this._oVariantSwitchPromise};d.prototype.createBaseChange=function(e,t){var n;var r;if(!t){throw new Error("No application component found. To offer flexibility a valid relation to its owning component must be present.")}e.reference=this.getComponentName();e.packageName="$TMP";n=o.createInitialFileContent(e);r=new o(n);if(e.variantReference){r.setVariantReference(e.variantReference)}return r};d.prototype._createChange=function(e,n,r){var o=r&&(r.controlType||t.getControlType(r));var i=this.createBaseChange(e,n);return this._getChangeHandler(i,o,r,g).then(function(o){if(o){o.completeChangeContent(i,e,{modifier:g,appComponent:n,view:t.getViewForControl(r)})}else{throw new Error("Change handler could not be retrieved for change "+JSON.stringify(e)+".")}return i}).catch(function(e){return Promise.reject(e)})};d.prototype.createChangeWithExtensionPointSelector=function(e,n){return Promise.resolve().then(function(){if(!n){throw new Error("A flexibility change on extension point cannot be created without a valid extension point reference.")}var r=n.view;var o=t.getAppComponentForControl(r);e.selector={name:n.name,viewSelector:g.getSelector(r.getId(),o)};return o}).then(function(t){return this._createChange(e,t)}.bind(this))};d.prototype.createChangeWithControlSelector=function(e,n){var r;return(new t.FakePromise).then(function(){if(!n){throw new Error("A flexibility change cannot be created without a targeted control.")}var o=n.id||n.getId();if(!e.selector){e.selector={}}r=n.appComponent||t.getAppComponentForControl(n);if(!r){throw new Error("No application component found. To offer flexibility, the control with the ID '"+o+"' has to have a valid relation to its owning application component.")}Object.assign(e.selector,g.getSelector(o,r));return r}).then(function(t){return this._createChange(e,t,n)}.bind(this))};d.prototype.addChange=function(e,n){return this.createChangeWithControlSelector(e,n).then(function(e){var r=t.getAppComponentForControl(n);e._ignoreOnce=true;this.addPreparedChange(e,r);e.setQueuedForApply();return e}.bind(this))};d.prototype.addPreparedChange=function(e,n){if(e.getVariantReference()){var r=n.getModel(t.VARIANT_MODEL_NAME);r.addChange(e)}this._oChangePersistence.addChange(e,n);return e};d.prototype.deleteChange=function(e,n){this._oChangePersistence.deleteChange(e);if(e.getVariantReference()){n.getModel(t.VARIANT_MODEL_NAME).removeChange(e)}};d.prototype.applyChange=function(e,n){var r={modifier:g,appComponent:t.getAppComponentForControl(n),view:t.getViewForControl(n)};return p.applyChangeOnControl(e,n,r).then(function(t){if(!t.success){var n=t.error||new Error("The change could not be applied.");this._oChangePersistence.deleteChange(e,true);throw n}return e}.bind(this))};function m(e,n,r,o,i){var a=v(e,o);if(!a){return[]}i.push(e);var s=e.getId();var p=n[s]&&n[s].dependencies||[];for(var h=0,c=p.length;h<c;h++){var g=t.getChangeFromChangesMap(r,p[h]);a=m(g,n,r,o,i);if(a.length===0){i=[];break}delete n[s]}return i}function v(e,t){var n=e.getDependentControlSelectorList();n.push(e.getSelector());return!n.some(function(e){return!g.bySelector(e,t)})}d.prototype.waitForChangesToBeApplied=function(e){var t;if(Array.isArray(e)){t=e}else{t=[e]}var n=t.map(function(e){return this._waitForChangesToBeApplied(e)}.bind(this));return Promise.all(n).then(function(){return undefined})};d.prototype._waitForChangesToBeApplied=function(e){var n=e.id&&sap.ui.getCore().byId(e.id)||e;var r=this._oChangePersistence.getChangesMapForComponent();var o=[];var i=Object.assign({},r.mDependencies);var a=r.mChanges;var s=a[n.getId()]||[];var p=s.filter(function(e){return!e.isCurrentProcessFinished()},this);var h=e.appComponent||t.getAppComponentForControl(n);var c=[];p.forEach(function(e){var t=m(e,i,r.mChanges,h,[]);t.forEach(function(e){if(c.indexOf(e)===-1){c.push(e)}})});c.forEach(function(e){o=o.concat(e.addChangeProcessingPromises())},this);o.push(this.waitForVariantSwitch());return Promise.all(o)};d.prototype.saveAll=function(e,r,o){var i=o?a.getVersionsModel({reference:t.normalizeReference(this._sComponentName),layer:n.CUSTOMER}).getProperty("/persistedVersion"):undefined;return this._oChangePersistence.saveDirtyChanges(e,r,undefined,i).then(function(e){if(o&&e&&e.response){var t=e.response;if(Array.isArray(t)){t=t[0]}a.onAllChangesSaved({reference:t.reference,layer:t.layer})}return e})};d.prototype.processXmlView=function(e,n){var r=l.get(n.componentId);var o=t.getAppComponentForControl(r);n.appComponent=o;n.modifier=u;n.view=e;return this._oChangePersistence.getChangesForView(n).then(p.applyAllChangesForXMLView.bind(p,n)).catch(this._handlePromiseChainError.bind(this,n.view))};d.prototype._handlePromiseChainError=function(e,t){f.error("Error processing view "+t+".");return e};d.prototype._getChangeHandler=function(e,t,n,r){var o=e.getChangeType();var i=e.getLayer();return this._getChangeRegistry().getChangeHandler(o,t,n,r,i)};d.prototype._getChangeRegistry=function(){var t=e.getInstance();t.initSettings();return t};d.prototype.getComponentChanges=function(e,t){return this._oChangePersistence.getChangesForComponent(e,t)};d.prototype.checkForOpenDependenciesForControl=function(e,t){return this._oChangePersistence.checkForOpenDependenciesForControl(e,t)};d.prototype._createChangePersistence=function(){this._oChangePersistence=i.getChangePersistenceForComponent(this.getComponentName());return this._oChangePersistence};d.prototype.resetChanges=function(e,t,n,r,o){return this._oChangePersistence.resetChanges(e,t,r,o).then(C.bind(this,n))};d.prototype.removeDirtyChanges=function(e,t,n,r,o){return this._oChangePersistence.removeDirtyChanges(e,t,n,r,o).then(C.bind(this,t))};d.prototype.applyVariantChanges=function(e,n){var r;return e.reduce(function(e,t){return e.then(function(){var e={modifier:g,appComponent:n};this._oChangePersistence._addRunTimeCreatedChangeAndUpdateDependencies(n,t);r=e.modifier.bySelector(t.getSelector(),n);if(r){return p.applyChangeOnControl(t,r,e)}f.error("A flexibility change tries to change a nonexistent control.")}.bind(this))}.bind(this),new t.FakePromise)};d.prototype.saveSequenceOfDirtyChanges=function(e,t){return this._oChangePersistence.saveDirtyChanges(t,false,e)};d.prototype.getResetAndPublishInfo=function(e){e.reference=this._sComponentName;return this._oChangePersistence.getResetAndPublishInfo(e)};return d},true);