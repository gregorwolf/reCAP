/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/LayerUtils","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/write/api/VersionsAPI","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/write/api/PersistenceWriteAPI","sap/base/util/UriParameters"],function(e,a,r,t,i,s){"use strict";function l(e){var a=!!r.getParameter(sap.ui.fl.Versions.UrlParameter);if(a){return Promise.resolve(false)}return i.isVersioningEnabled(e.layer).then(function(a){return a&&t.isDraftAvailable({selector:e.selector,layer:e.layer})})}function n(e){var r=this.hasMaxLayerParameterWithValue({value:e.layer});var t=e.layer===a.USER;if(t||r){return Promise.resolve(false)}return s.hasHigherLayerChanges({selector:e.selector,ignoreMaxLayerParameter:e.ignoreMaxLayerParameter,upToLayer:e.layer,includeCtrlVariants:e.includeCtrlVariants,includeDirtyChanges:true})}var o={getReloadReasonsForStart:function(e){return Promise.all([n.call(this,e),l(e)]).then(function(a){e.hasHigherLayerChanges=a[0];e.isDraftAvailable=a[1];return e})},hasVersionParameterWithValue:function(e){return r.hasParameterAndValue(sap.ui.fl.Versions.UrlParameter,e.value)},hasMaxLayerParameterWithValue:function(a){var t=e.FL_MAX_LAYER_PARAM;return r.hasParameterAndValue(t,a.value)},handleUrlParametersForStandalone:function(a){if(a.hasHigherLayerChanges){a.parameters=r.handleUrlParameters(a.parameters,e.FL_MAX_LAYER_PARAM,a.layer)}var t=new RegExp("&*"+sap.ui.fl.Versions.UrlParameter+"=-?\\d*&?","g");a.parameters=a.parameters.replace(t,"");if(a.isDraftAvailable&&!a.onExit){a.parameters=r.handleUrlParameters(a.parameters,sap.ui.fl.Versions.UrlParameter,sap.ui.fl.Versions.Draft)}if(a.versionSwitch){a.parameters=r.handleUrlParameters(a.parameters,sap.ui.fl.Versions.UrlParameter,a.version)}if(a.parameters==="?"){a.parameters=""}return a.parameters},handleParametersOnStart:function(a){var t=r.getParsedURLHash();t.params=t.params||{};if(a.hasHigherLayerChanges){t.params[e.FL_MAX_LAYER_PARAM]=[a.layer]}if(a.isDraftAvailable){t.params[sap.ui.fl.Versions.UrlParameter]=[sap.ui.fl.Versions.Draft]}return t},initialDraftGotActivated:function(e){if(e.versioningEnabled){var a=this.hasVersionParameterWithValue({value:sap.ui.fl.Versions.Draft.toString()});return!t.isDraftAvailable(e)&&a}return false},getReloadMethod:function(e){var a={NOT_NEEDED:"NO_RELOAD",RELOAD_PAGE:"HARD_RELOAD",VIA_HASH:"CROSS_APP_NAVIGATION"};e.reloadMethod=a.NOT_NEEDED;e.isDraftAvailable=e.isDraftAvailable||o.hasVersionParameterWithValue({value:sap.ui.fl.Versions.Draft.toString()});if(e.activeVersion>sap.ui.fl.Versions.Original){e.activeVersionNotSelected=e.activeVersion&&!o.hasVersionParameterWithValue({value:e.activeVersion.toString()})}e.hasHigherLayerChanges=o.hasMaxLayerParameterWithValue({value:e.layer});e.initialDraftGotActivated=o.initialDraftGotActivated(e);if(e.initialDraftGotActivated){e.isDraftAvailable=false}if(e.changesNeedReload||e.isDraftAvailable||e.hasHigherLayerChanges||e.initialDraftGotActivated||e.activeVersionNotSelected){e.reloadMethod=a.RELOAD_PAGE;if(!e.changesNeedReload&&r.getUshellContainer()){e.reloadMethod=a.VIA_HASH}}return e}};return o});