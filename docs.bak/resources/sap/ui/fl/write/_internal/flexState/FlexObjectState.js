/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/apply/_internal/ChangesController","sap/ui/fl/write/_internal/flexState/compVariants/CompVariantState","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/LayerUtils","sap/ui/fl/Utils"],function(e,t,n,r,a,o,i,l){"use strict";var c={};function s(e){e.reference=n.getFlexReferenceForControl(e.selector);return t.initialize({componentId:e.componentId||l.getAppComponentForControl(e.selector).getId(),reference:e.reference,componentData:{},manifest:{}})}function f(e){var n=t.getCompEntitiesByIdMap(e.reference);var r=Object.keys(n).map(function(e){return n[e]});return i.filterChangeOrChangeDefinitionsByCurrentLayer(r,e.currentLayer)}function p(e){var t=n.getFlexReferenceForControl(e.selector);return a.persistAll(t)}function u(e){if(!e.reference){var t=r.getAppComponentForSelector(e.selector);e.reference=n.getFlexReferenceForControl(t)}return o.getChangePersistenceForComponent(e.reference)}function C(t){var n=u(t);return n.getChangesForComponent(e(t,["invalidateCache","selector"]),t.invalidateCache).then(function(e){var r=[];if(t.includeDirtyChanges){r=n.getDirtyChanges()}return e.concat(r)})}function g(e,t){var n=r.getFlexControllerInstance(e.selector);var a=r.getDescriptorFlexControllerInstance(e.selector);return n.saveAll(t,e.skipUpdateCache,e.draft).then(a.saveAll.bind(a,t,e.skipUpdateCache,e.draft))}c.getFlexObjects=function(e){return s(e).then(function(){var t=f(e);var n=C(e);return Promise.all([t,n]).then(function(e){return e[0].concat(e[1])})})};c.saveFlexObjects=function(t){var n=r.getAppComponentForSelector(t.selector);return Promise.all([p(t),g(t,n)]).then(function(){if(t.layer){t.currentLayer=t.layer}t.componentId=n.getId();t.invalidateCache=true;return c.getFlexObjects(e(t,"skipUpdateCache"))})};return c});