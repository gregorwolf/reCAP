/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/restricted/_pick","sap/base/util/UriParameters","sap/ui/fl/Layer","sap/ui/fl/Change","sap/ui/fl/apply/_internal/flexObjects/CompVariant","sap/ui/fl/apply/_internal/flexObjects/CompVariantRevertData","sap/ui/fl/Utils","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/registry/Settings","sap/ui/fl/write/_internal/Storage"],function(e,t,n,a,r,i,s,o,c,f,u){"use strict";function p(e){switch(e.fileType){case"change":case"variant":return"changes";case"comp_variant_change":return"compVariantChanges";default:}}function l(e,t){var n=e.changeToBeAddedOrDeleted.getDefinition();var a=p(n);t[a].push(n);var r=n.fileName;var i=c.getCompEntitiesByIdMap(e.reference);i[r]=n}function d(e,t){var n=e.changeToBeAddedOrDeleted.getDefinition();var a=p(n);var r=-1;t[a].some(function(e,t){if(e.fileName===n.fileName){r=t;return true}});if(r>-1){t[a].splice(r,1)}var i=c.getCompEntitiesByIdMap(e.reference);delete i[n.fileName]}function g(e,t,n){var i=c.getCompVariantsMap(e.reference)._getOrCreate(e.persistencyKey);if(!i[n]){var s={fileName:o.createDefaultFileName(n),fileType:"change",changeType:n,layer:e.layer||a.USER,namespace:o.createNamespace(e,"changes"),reference:e.reference,selector:{persistencyKey:e.persistencyKey},support:e.support||{}};s.support.generator=s.support.generator||"CompVariantState."+n;s.support.sapui5Version=sap.ui.version;var f=new r(s);i[n]=f;c.getCompEntitiesByIdMap(e.reference)[f.getId()]=f}i[n].setContent(t);return i[n]}function v(e,t){for(var n=e.length-1;n>=0;n--){if((e[n].fileName||e[n].getFileName())===t.fileName){e.splice(n,1);break}}}function y(e,t){if(t.isVariant()){return e.variants}switch(t.getChangeType()){case"defaultVariant":return e.defaultVariants;case"standardVariant":return e.standardVariants;default:return e.changes}}function m(e,t){return u.write({flexObjects:[e.getDefinition()],layer:e.getLayer(),transport:e.getRequest(),isLegacyVariant:e.isVariant()}).then(function(n){if(n&&n.response&&n.response[0]){e.setResponse(n.response[0])}else{e.setState(r.states.PERSISTED)}return t}).then(function(t){y(t.changes.comp,e).push(e.getDefinition());return e.getDefinition()})}function h(e,t){for(var n=0;n<e.length;n++){if(e[n].fileName===t.fileName){e.splice(n,1,t);break}}}function S(e,t){return u.update({flexObject:e.getDefinition(),layer:e.getLayer(),transport:e.getRequest()}).then(function(n){if(n&&n.response){e.setResponse(n.response)}else{e.setState(r.states.PERSISTED)}return t}).then(function(t){var n=y(t.changes.comp,e);h(n,e.getDefinition());return e.getDefinition()})}function C(e,t,n,a){return u.remove({flexObject:e.getDefinition(),layer:e.getLayer(),transport:e.getRequest()}).then(function(){delete t[e.getId()];if(e.getChangeType()==="standardVariant"){n.standardVariant=undefined}else if(e.getChangeType()==="defaultVariant"){n.defaultVariant=undefined}else{v(y(n,e),e.getDefinition())}return a}).then(function(t){v(y(t.changes.comp,e),e.getDefinition());return e.getDefinition()})}function x(e){return e&&(e.getPendingAction()==="NEW"||e.getPendingAction()==="UPDATE"||e.getPendingAction()==="DELETE")}function O(e){return e.variants.concat(e.changes).concat(e.defaultVariant).concat(e.standardVariant)}function E(e){var t={};if(typeof e.texts==="object"){Object.keys(e.texts).forEach(function(n){t[n]={value:e.texts[n],type:"XFLD"}})}return t}function V(e){if(e.layer){return e.layer}if(e.isUserDependent){return a.USER}var t=n.fromQuery(window.location.search).get("sap-ui-layer")||"";t=t.toUpperCase();if(t){return t}if(!e.isVariant){return a.CUSTOMER}var r=f.getInstanceOrUndef().isPublicLayerAvailable();return r?a.PUBLIC:a.CUSTOMER}function D(e){var t=c.getCompEntitiesByIdMap(e.reference);return t[e.id]}function T(e){if(e instanceof i){e.removeAllRevertInfo()}}var b={};b.setDefault=function(e){var t={defaultVariantName:e.defaultVariantId};return g(e,t,"defaultVariant")};b.setExecuteOnSelection=function(e){var t={executeOnSelect:e.executeOnSelection};return g(e,t,"standardVariant")};b.add=function(e){if(!e){return undefined}var t=e.changeSpecificData;var n={changeType:t.type,service:t.ODataService,content:t.content||{},reference:e.reference,fileType:t.isVariant?"variant":"change",packageName:t.packageName,layer:V(t),selector:{persistencyKey:e.persistencyKey},texts:E(t),command:e.command,generator:e.generator};if(t.isVariant){n.content.favorite=!!t.favorite;n.content.executeOnSelection=t.content.executeOnSelection||!!t.executeOnSelection;n.contexts=t.contexts||{}}var a=t.isVariant?i:r;var s=a.createInitialFileContent(n);var o=new a(s);var f=c.getCompVariantsMap(e.reference);var u=f._getOrCreate(e.persistencyKey);y(u,o).push(o);var p=o.getId();var l=c.getCompEntitiesByIdMap(e.reference);l[p]=o;return o};function N(e,t){var n=[];if(e.favorite===undefined){n.push("favorite")}if(e.executeOnSelection===undefined){n.push("executeOnSelection")}var a={type:b.operationType.ContentUpdate,content:{previousState:t.getState(),previousContent:t.getContent(),previousFavorite:t.getFavorite(),previousExecuteOnSelection:t.getExecuteOnSelection(),previousContexts:t.getContexts()}};if(e.name){a.content.previousName=t.getText("variantName")}t.addRevertInfo(new s(a))}b.updateVariant=function(e){var t=D(e);if(!t){throw new Error("Variant to be modified is not persisted via sap.ui.fl.")}if(!e.revert){N(e,t)}if(e.name){t.setText("variantName",e.name)}var n=t.getContent();var a=e.content||n;["favorite","executeOnSelection"].forEach(function(t){if(e[t]!==undefined){a[t]=e[t]}else if(!(e.revert&&a[t]!==undefined)&&n[t]!==undefined){a[t]=n[t]}});t.setContent(a);t.setFavorite(!!a.favorite);t.setExecuteOnSelection(!!a.executeOnSelection);if(e.contexts){t.setContexts(e.contexts)}return t};b.operationType={StateUpdate:"StateUpdate",ContentUpdate:"ContentUpdate"};b.removeVariant=function(e){var t=D(e);if(!e.revert){var n=new s({type:b.operationType.StateUpdate,content:{previousState:t.getState()}});t.addRevertInfo(n)}t.markForDeletion();return t};b.revert=function(e){var n=D(e);var a=n.getRevertInfo().pop();var r=a.getContent();switch(a.getType()){case b.operationType.ContentUpdate:b.updateVariant(Object.assign({revert:true,name:r.previousName,content:r.previousContent,favorite:r.previousFavorite,executeOnSelection:r.previousExecuteOnSelection,contexts:r.previousContexts},t(e,["reference","persistencyKey","id"])));break;case b.operationType.StateUpdate:default:break}n.setState(r.previousState);n.removeRevertInfo(a);return n};b.updateState=function(e){var t=c.getFlexObjectsFromStorageResponse(e.reference);if(e.changeToBeAddedOrDeleted){switch(e.changeToBeAddedOrDeleted.getPendingAction()){case r.states.NEW:l(e,t);break;case r.states.DELETED:d(e,t);break;default:break}}};b.persist=function(e){var t=e.reference;var n=e.persistencyKey;var a=c.getCompVariantsMap(t);var i=a._getOrCreate(n);var s=c.getCompEntitiesByIdMap(t);var o=c.getStorageResponse(t);var f=O(i).filter(x).map(function(e){switch(e.getPendingAction()){case r.states.NEW:T(e);return m(e,o);case r.states.DIRTY:T(e);return S(e,o);case r.states.DELETED:T(e);return C(e,s,i,o);default:break}});return Promise.all(f)};b.persistAll=function(t){var n=e(c.getCompVariantsMap(t),"_getOrCreate");var a=Object.keys(n).map(function(e){return b.persist({reference:t,persistencyKey:e})});return Promise.all(a)};return b});