/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/security/encodeURLParameters","sap/base/Log","sap/ui/core/Core","sap/ui/fl/registry/Settings","sap/ui/fl/Utils","sap/ui/util/Storage","sap/ui/thirdparty/jquery"],function(e,t,r,i,s,n,a){"use strict";var o={};o._mServiceType={v2:"v2",v4:"v4"};o._sODataV4ResourcePathPrefix="sap/opu/odata4/";o._sStorageKey="sap.ui.fl.fieldExt.Access";o._iValidityPeriod=1*7*24*60*60*1e3;function c(e,t){t=t||e.getModel();var r=e.getBindingContext();if(r&&t.oMetadata){return t.oMetadata._getEntityTypeByPath(r.getPath())}return{}}function u(e,t){e.BusinessContexts=e.BusinessContexts.map(function(e){return{description:e.BusinessContextDescription,businessContext:e.BusinessContext}});return{extensionData:e.BusinessContexts,entityType:t,serviceVersion:e.ServiceVersion,serviceName:e.ServiceName}}o.getTexts=function(){var e=r.getLibraryResourceBundle("sap.ui.fl");return{tooltip:e.getText("BTN_FREP_CCF"),headerText:e.getText("BUSINESS_CONTEXT_TITLE")}};o.isExtensibilityEnabled=function(e){var t=s.getComponentClassName(e);if(!t){return Promise.resolve(false)}return i.getInstance(t).then(function(e){return e.isModelS()})};o.getExtensionData=function(e){var r=e.getModel().sServiceUrl;var i=c(e).name;var s=false;try{s=o.getBusinessContexts(r,i)}catch(e){t.error("exception occured in sap.ui.fl.fieldExt.Access.getBusinessContexts",e)}return Promise.resolve(s).then(function(e){if(e&&Array.isArray(e.BusinessContexts)&&e.BusinessContexts.length>0){return u(e,i)}return false}).catch(function(e){if(e){if(Array.isArray(e.errorMessages)){e.errorMessages.forEach(function(e){t.error(e.text)})}}return false})};o.onTriggerCreateExtensionData=function(e){s.ifUShellContainerThen(function(t){var r=t[0];var i=r&&r.hrefForExternal({target:{semanticObject:"CustomField",action:"develop"},params:{businessContexts:e.extensionData.map(function(e){return e.businessContext}),serviceName:e.serviceName,serviceVersion:e.serviceVersion,entityType:e.entityType}});o.openNewWindow(i)},["CrossApplicationNavigation"])};o.getBusinessContexts=function(e,t,r){var i=this._getEntityInfo(t,r);var s=this._parseServiceUri(e);var n=this._buildBusinessContextRetrievalUri(s,i);var a=this._executeAjaxCall(n,s,i);return a};o.isServiceOutdated=function(e){if(!this._isSystemInfoAvailable()){return false}var t=this._getServiceItem(this._createServiceItem(e));if(t){if(this._isServiceExpired(t)){this.setServiceValid(e);return false}return true}return false};o.openNewWindow=function(e){window.open(e,"_blank","noopener noreferrer")};o.setServiceValid=function(e){if(this._isSystemInfoAvailable()){var t=this._getDataFromLocalStorage();delete t[this._createServiceItem(e).serviceKey];this._setDataToLocalStorage(t)}};o.setServiceInvalid=function(e){if(this._isSystemInfoAvailable()){var t=this._getDataFromLocalStorage();var r=this._createServiceItem(e);t[r.serviceKey]=r;this._setDataToLocalStorage(t)}};o._getEntityInfo=function(e,t){var r={entityTypeName:e||"",entitySetName:t||""};if(r.entitySetName.length===0&&r.entityTypeName.length===0||!(r.entitySetName.length===0)&&!(r.entityTypeName.length===0)){throw new Error("sap.ui.fl.fieldExt.Access._getEntityInfo()"+"Inconsistent input parameters EntityType: "+r.entityTypeName+" EntitySet: "+r.entitySetName)}return r};o._parseServiceUri=function(e){if(e.toLowerCase().indexOf(this._sODataV4ResourcePathPrefix)!==-1){return this._parseV4ServiceUri(e)}return this._parseV2ServiceUri(e)};o._parseV2ServiceUri=function(e){var t=/.*sap\/opu\/odata\/([^\/]+)\/([^\/]+)/i;var r=/([^;]+);v=(\d{1,4})/i;var i="sap/opu/odata";var s;if(e.toLowerCase().indexOf(i)!==-1){var n=e.match(t);if(!n||n.length!==3){throw new Error("sap.ui.fl.fieldExt.Access._parseV2ServiceUri: Malformed service URI (Invalid service name)")}if(n[1].toLowerCase()!=="sap"){s="/"+n[1]+"/"+n[2]}else{s=n[2]}}else{if(e.length>0&&e.lastIndexOf("/")+1===e.length){e=e.substring(0,e.length-1)}s=e.substring(e.lastIndexOf("/")+1)}if(s.indexOf(";v=")!==-1){var a=s.match(r);if(!a||a.length!==3){throw new Error("sap.ui.fl.fieldExt.Access._parseV2ServiceUri: Malformed service URI (Invalid version)")}return{serviceName:a[1],serviceVersion:a[2],serviceType:this._mServiceType.v2}}return{serviceName:s,serviceVersion:"0001",serviceType:this._mServiceType.v2}};o._parseV4ServiceUri=function(e){var t=/^\/?sap\/opu\/odata4((?:\/[^/]+){5})(\/[^/]+){1}(\/.*)?/i;var r=e.match(t);if(!r||r.length!==4){throw new Error("sap.ui.fl.fieldExt.Access._parseV4ServiceUri: Malformed service URI")}var i=r[1].split("/");i.splice(0,3);var s=/(\d{1,4})/i;var n=r[2].match(s);return{serviceName:i.join("/"),serviceVersion:n[1],serviceType:this._mServiceType.v4}};o._buildBusinessContextRetrievalUri=function(t,r){var i="/sap/opu/odata/SAP/APS_CUSTOM_FIELD_MAINTENANCE_SRV/";if(t.serviceType===this._mServiceType.v4){var s=this._sODataV4ResourcePathPrefix+t.serviceName+"/"+t.serviceVersion;i+="GetBusinessContextsByResourcePath?"+e({ResourcePath:"'"+s+"'"})}else{i+="GetBusinessContextsByEntityType?"+"ServiceName='"+t.serviceName+"'"+"&ServiceVersion='"+t.serviceVersion+"'"}i+="&EntitySetName='"+r.entitySetName+"'"+"&EntityTypeName='"+r.entityTypeName+"'"+"&$format=json";return i};o._executeAjaxCall=function(e,t,r){var i=this;var s=this._getAjaxSettings();var n=a.Deferred();var o={BusinessContexts:[],ServiceName:t.serviceName,ServiceVersion:t.serviceVersion};a.ajax(e,s).done(function(e){o.BusinessContexts=i._extractBusinessContexts(e);n.resolve(o)}).fail(function(e){if(e.status===404&&t.serviceType===i._mServiceType.v4){n.resolve(o)}else{var s=i._getMessagesFromXHR(e);var a={errorOccured:true,errorMessages:s,serviceName:t.serviceName,serviceVersion:t.serviceVersion,entityType:r.entityTypeName,entitySet:r.entitySetName};n.reject(a)}});return n.promise()};o._getAjaxSettings=function(){var e={type:"GET",async:true,dataType:"json"};return e};o._extractBusinessContexts=function(e){var t=null;var r=[];if(e&&e.d){t=e.d.results}if(t!==null&&t.length>0){for(var i=0;i<t.length;i++){if(t[i].BusinessContext!==null){r.push({BusinessContext:t[i].BusinessContext,BusinessContextDescription:t[i].BusinessContextDescription})}}}return r};o._getMessagesFromXHR=function(e){var t=[];try{var r=JSON.parse(e.responseText);if(r&&r.error&&r.error.message&&r.error.message.value&&r.error.message.value!==""){t.push({severity:"error",text:r.error.message.value})}else{t.push({severity:"error",text:e.responseText})}}catch(e){}return t};o._getCurrentTime=function(){return Date.now()};o._isServiceExpired=function(e){return e.expirationDate<=this._getCurrentTime()};o._getLocalStorage=function(){return new n(n.Type.local)};o.isLocalStorageAvailable=function(){return this._getLocalStorage()&&this._getLocalStorage().isSupported()};o._getServiceItem=function(e){return this._getDataFromLocalStorage()[e.serviceKey]||null};o._createServiceItem=function(e){var t=this._getCurrentTime()+this._iValidityPeriod;var r=this._getSystemInfo();var i=this._extractServiceInfo(e);return{serviceKey:r.getName()+r.getClient()+i.serviceName+i.serviceVersion,expirationDate:t}};o._extractServiceInfo=function(e){if(typeof e==="string"){return this._parseServiceUri(e)}return e};o._isSystemInfoAvailable=function(){var e=s.getUshellContainer();return e&&e.getLogonSystem};o._getSystemInfo=function(){var e=s.getUshellContainer();return e&&e.getLogonSystem()};o._setDataToLocalStorage=function(e){if(this.isLocalStorageAvailable()){this._getLocalStorage().put(o._sStorageKey,JSON.stringify(e))}};o._getDataFromLocalStorage=function(){if(!this.isLocalStorageAvailable()){return{}}var e=this._getLocalStorage().get(o._sStorageKey);if(!e){return{}}return JSON.parse(e)};return o},true);