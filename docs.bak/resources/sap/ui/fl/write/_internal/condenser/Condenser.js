/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/each","sap/base/util/isPlainObject","sap/base/util/isEmptyObject","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Core","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/write/_internal/condenser/classifications/LastOneWins","sap/ui/fl/write/_internal/condenser/classifications/Reverse","sap/ui/fl/write/_internal/condenser/UIReconstruction","sap/ui/fl/write/_internal/condenser/Utils","sap/ui/fl/Change","sap/ui/fl/Utils","sap/ui/performance/Measurement"],function(e,n,t,i,s,a,r,o,f,c,l,u,d){"use strict";var p={};var C="unclassified";var h={lastOneWins:r,reverse:o};function g(e,n){return n.classification===sap.ui.fl.condenser.Classification.Create&&e[sap.ui.fl.condenser.Classification.Move]}function v(e,n){return n.classification===sap.ui.fl.condenser.Classification.Move&&e[sap.ui.fl.condenser.Classification.Destroy]}function y(e,n){return n.classification===sap.ui.fl.condenser.Classification.Create&&e[sap.ui.fl.condenser.Classification.Destroy]}function E(e,n,t,i){if(!v(e,t)&&!y(e,t)){var s=t.classification;if(!e[s]){t.change=i;i.condenserState="select";e[s]=[t]}else{i.condenserState="delete"}e[s][0].updateChange=i}if(g(e,t)||y(e,t)){if(e[sap.ui.fl.condenser.Classification.Move]){e[sap.ui.fl.condenser.Classification.Move].forEach(function(e){e.change.condenserState="delete"});delete e[sap.ui.fl.condenser.Classification.Move]}if(e[sap.ui.fl.condenser.Classification.Destroy]){e[sap.ui.fl.condenser.Classification.Destroy].forEach(function(e){e.change.condenserState="delete"});delete e[sap.ui.fl.condenser.Classification.Destroy]}}f.addChange(n,t)}function m(e,n,t,i,s){if(!e[i.type]){e[i.type]={}}var a=e[i.type];if(i.type===c.NOT_INDEX_RELEVANT){if(!a[i.classification]){a[i.classification]={}}var r=a[i.classification];h[i.classification].addToChangesMap(r,i.uniqueKey,s)}else{t.push(s);E(a,n,i,s)}}function _(e,n,t){if(!e[n]){e[n]=[]}e[n].push(t);t.condenserState="select"}function I(e,n){var t=i.getControlIdBySelector(n.getSelector(),e);var r=s.byId(t);if(r){var o={modifier:i,appComponent:e,view:u.getViewForControl(r)};var f=a.getControlIfTemplateAffected(n,r,o);return Promise.resolve(a.getChangeHandler(n,f,o)).then(function(e){if(e&&typeof e.getCondenserInfo==="function"){return e.getCondenserInfo(n,o)}})}return Promise.resolve()}function S(e,n,t,s){var a=n!==undefined?n.affectedControl:i.getControlIdBySelector(t.getSelector(),s);if(!e[a]){e[a]={}}return e[a]}function N(e,n,t,i,s){return s.reduce(function(s,a){return s.then(M.bind(this,e,n,t,i,a))}.bind(this),Promise.resolve())}function M(e,n,t,i,s){return I(e,s).then(function(a){D(a,e);var r=S(n,a,s,e);if(a!==undefined){A(a);m(r,t,i,a,s)}else{_(r,C,s);n[C]=true}})}function A(e){if(h[e.classification]){e.type=c.NOT_INDEX_RELEVANT}else{e.type=c.INDEX_RELEVANT}}function D(e,n){["affectedControl","sourceContainer","targetContainer"].forEach(function(t){if(e&&e[t]){e[t]=i.getControlIdBySelector(e[t],n)}})}function O(t,i){e(t,function(e,s){if(h[e]&&h[e].getChangesFromMap){h[e].getChangesFromMap(t,e).forEach(function(e){i.push(e)})}else if(n(s)){return O(s,i)}else if(Array.isArray(s)){s.forEach(function(e){if(e instanceof l){i.push(e)}else{i.push(e.change)}})}});return i}function R(e){return O(e,[])}function T(t,i){e(t,function(e,t){if(n(t)){T(t,i)}else if(Array.isArray(t)){t.forEach(function(e){if(!(e instanceof l)){i.push(e)}})}});return i}function b(e,n){n.sort(function(n,t){return e.indexOf(n)-e.indexOf(t)})}function x(e,n){var t=e.map(function(e){return e.getId()});n.forEach(function(n){if(t.indexOf(n.getId())===-1){e.push(n)}})}function F(e,n){e.forEach(function(e){var t=e.updateChange;if(t&&t.getState()!==l.states.NEW){var i=e.change;if(t.getFileName()!==i.getFileName()){var s=i.getContent();t.setContent(s);i.condenserState="delete";n=n.map(function(e){if(e.getFileName()===i.getFileName()){return t}return e})}else{t.setState(l.states.DIRTY)}t.condenserState="update"}});return n}p.condense=function(e,n){d.start("Condenser_overall","Condenser overall - CondenserClass",["sap.ui.fl","Condenser"]);var t={};var i={};var s=[];var a=[];var r=[];n.slice(0).reverse().forEach(function(e){if(e instanceof l&&e.isApplyProcessFinished()){r.push(e)}else{a.push(e)}});d.start("Condenser_defineMaps","defining of maps - CondenserClass",["sap.ui.fl","Condenser"]);return N(e,t,i,s,r).then(function(){d.end("Condenser_defineMaps");var e=t[C];if(!e){f.compareAndUpdate(t,i)}var r=R(t);if(e){s.forEach(function(e){e.condenserState="select"});x(r,s)}r=r.concat(a);b(n,r);if(!e){d.start("Condenser_handleIndexRelatedChanges","handle index related changes - CondenserClass",["sap.ui.fl","Condenser"]);var o=T(t,[]);d.start("Condenser_sort","sort index related changes - CondenserClass",["sap.ui.fl","Condenser"]);var c=f.sortIndexRelatedChanges(i,o);d.end("Condenser_sort");f.swapChanges(c,r);r=F(o,r);d.end("Condenser_handleIndexRelatedChanges")}d.end("Condenser_overall");return r})};return p});