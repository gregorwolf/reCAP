/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_isEqual","sap/base/util/each","sap/ui/fl/write/_internal/condenser/classifications/Create","sap/ui/fl/write/_internal/condenser/classifications/Destroy","sap/ui/fl/write/_internal/condenser/classifications/Move","sap/ui/fl/write/_internal/condenser/Utils"],function(n,e,t,i,r,a){"use strict";var c={};var f={create:t,destroy:i,move:r};function o(n,t){e(n,function(n,i){e(i,function(e,r){t(i,n,r,e)})})}function s(n,e,t){n.splice(t,0,n.splice(e,1)[0])}function u(n,e){var t={};o(n,function(n,i,r,c){var f=r[a.TARGET_UI];f.forEach(function(n){e.forEach(function(e){if(n===e.affectedControl){if(!t[i]){t[i]={}}var r=t[i];if(!r[c]){r[c]=[]}var a=r[c];a.push(e)}})})});return t}function l(n){return!n.some(function(n){return n.classification!==sap.ui.fl.condenser.Classification.Create})}function h(n){return!n.some(function(n){return a.isUnknown(n)})}function v(n){return n.getTargetIndex(n.change)}function d(n){n.sort(function(n,e){var t=v(n);var i=v(e);return t-i})}function g(n){return!n.some(function(n){return!a.isUnknown(n)})}function E(n,e){var t=e.targetContainer;var i=e.affectedControl;var r=e.getTargetIndex(e.change);var c=n[t][e.targetAggregation];a.extendArrayWithPlaceholders(c,undefined,r);var f=c.indexOf(i);s(c,f,r)}function I(e,t){var i;if(e.length<t.length){i=t.slice(e.length);if(!g(i)){return false}t=t.slice(0,e.length)}else if(e.length>t.length){i=e.slice(t.length,e.length);if(!g(i)){return false}e=e.slice(0,t.length)}return n(e,t)}function T(n,e,t,i,r){var c={};r.forEach(function(n){var i=n.targetContainer;if(!c[i]){c[i]={}}var r=c[i];if(!r[e]){r[e]=a.initializeArrayWithPlaceholders(0,t.length-1)}f[n.classification].simulate(r[e],n,t)});r.forEach(function(n){if(n.classification===sap.ui.fl.condenser.Classification.Move){E(c,n)}});var o=c[n][e];if(I(i,o)){return true}return false}function p(n,t){o(t,function(t,i,r){r[a.TARGET_UI].forEach(function(t,i){if(!a.isUnknown(t)){var r=n[t];var c=r[a.INDEX_RELEVANT];e(c,function(n,e){if(n!==sap.ui.fl.condenser.Classification.Destroy){e.forEach(function(n){n.setTargetIndex(n.change,i);n.change.condenserState="select"})}})}})})}function A(n,t){o(t,function(t,i,r,c){var f=r[a.INITIAL_UI];var o=r[a.TARGET_UI];if(I(f,o)){o.forEach(function(t){var i=n[t];if(i!==undefined){e(i[a.INDEX_RELEVANT],function(n,e){e.forEach(function(n){n.change.condenserState="delete"})});delete i[a.INDEX_RELEVANT]}});delete t[c]}})}function _(n,e){o(e,function(e,t,i){var r=i[a.INITIAL_UI];var c=i[a.TARGET_UI];r.forEach(function(e,t){var i=n[e];if(!i||!i[a.INDEX_RELEVANT]){var r=a.PLACEHOLDER+t;var f=c.indexOf(e);if(f>=0){c[f]=r}}})})}c.swapChanges=function(n,e){var t=n.map(function(n){return e.indexOf(n)}).sort();n.forEach(function(n){e[t.shift()]=n})};c.sortIndexRelatedChanges=function(n,e){var t=[];var i=u(n,e);o(i,function(e,i,r,c){var f=n[i][c][a.TARGET_UI];var o=n[i][c][a.INITIAL_UI];if(h(f)||l(r)){d(r)}else if(!T(i,c,o,f,r)){var u=false;var v=r.length;while(v!==0&&!u){var g=0;var E=1;while(E<r.length&&!u){s(r,g,E);u=T(i,c,o,f,r);g++;E++}v--}}r.forEach(function(n){t=t.concat(n.change)})});return t};c.addChange=function(n,e){f[e.classification].addToReconstructionMap(n,e)};c.compareAndUpdate=function(n,e){A(n,e);_(n,e);p(n,e)};return c});