/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Utils","sap/ui/thirdparty/jquery","sap/ui/fl/registry/ChangeRegistryItem","sap/ui/fl/registry/ChangeTypeMetadata","sap/ui/fl/registry/Settings","sap/ui/fl/changeHandler/HideControl","sap/ui/fl/changeHandler/MoveElements","sap/ui/fl/changeHandler/MoveControls","sap/ui/fl/changeHandler/PropertyChange","sap/ui/fl/changeHandler/PropertyBindingChange","sap/ui/fl/changeHandler/UnhideControl","sap/ui/fl/changeHandler/StashControl","sap/ui/fl/changeHandler/UnstashControl","sap/ui/fl/changeHandler/AddXML","sap/ui/fl/changeHandler/AddXMLAtExtensionPoint","sap/ui/fl/requireAsync","sap/base/Log"],function(e,t,r,n,a,i,o,s,g,l,h,d,c,p,f,y,u){"use strict";var C=function(){this._registeredItems={};this.initSettings();this.initDeveloperModeChangeHandlers()};C._instance=undefined;C.prototype._oDefaultActiveChangeHandlers={};C.prototype._oDefaultChangeHandlers={hideControl:i,moveElements:o,moveControls:s,unhideControl:h,stashControl:d,unstashControl:c};C.prototype._mDeveloperModeChangeHandlers={propertyChange:{changeHandler:g},propertyBindingChange:{changeHandler:l},addXML:{changeHandler:p},addXMLAtExtensionPoint:{changeHandler:f}};C.prototype.initDeveloperModeChangeHandlers=function(){Object.keys(this._mDeveloperModeChangeHandlers).forEach(function(e){var t=this._mDeveloperModeChangeHandlers[e].changeHandler;var r=this._oSettings.getDeveloperModeLayerPermissions();var n={changeType:e,changeHandler:t,layers:r};var a=this._createChangeRegistryItemForSimpleChange("defaultActiveForAllControls",n);this._oDefaultActiveChangeHandlers[e]=a}.bind(this))};C.getInstance=function(){if(!C._instance){C._instance=new C}return C._instance};C.prototype.hasRegisteredChangeHandlersForControl=function(e){var t=Object.keys(this._registeredItems);return t.indexOf(e)!==-1};C.prototype.hasChangeHandlerForControlAndChange=function(e,t){if(!this.hasRegisteredChangeHandlersForControl(e)){return false}var r=this._registeredItems[e];var n=Object.keys(r);return n.indexOf(t)!==-1};C.prototype.registerControlsForChanges=function(e){var r=[];t.each(e,function(e,t){var n={};if(Array.isArray(t)){t.forEach(function(e){n[e.changeType]=e.changeHandler})}else{n=t}r.push(this._registerChangeHandlersForControl(e,n))}.bind(this));return Promise.all(r)};C.prototype._registerChangeHandlersForControl=function(e,r){var n=Promise.resolve(r);var a="ChangeRegistry._registerChangeHandlersForControl.skip_next_then";if(typeof r==="string"){n=y(r+".flexibility").catch(function(t){u.error("Flexibility change handler registration failed.\nControlType: "+e+"\n"+t.message);return Promise.resolve(a)})}return n.then(function(r){if(r!==a){t.each(r,function(t,r){var n=this._getChangeHandlerEntry(t,r);var a={changeType:t,changeHandler:n.changeHandler,layers:n.layers};this.registerControlForSimpleChange(e,a)}.bind(this))}}.bind(this))};C.prototype._getInstanceSpecificChangeRegistryItem=function(t,r,n){var a=n&&n.getChangeHandlerModulePath(r);if(typeof a!=="string"){return new e.FakePromise(undefined)}return y(a).then(function(e){var a=e[t];if(!a){return undefined}var i=this._getChangeHandlerEntry(t,a);var o={changeType:t,changeHandler:i.changeHandler,layers:i.layers};var s=n.getControlType(r);var g=this._createChangeRegistryItemForSimpleChange(s,o);return g}.bind(this)).catch(function(e){u.error("Flexibility registration for control "+n.getId(r)+" failed to load module "+a+"\n"+e.message);return undefined})};C.prototype._getChangeHandlerEntry=function(e,t){var r={};var n=Object.keys(this._mDeveloperModeChangeHandlers);if(!t||!t.changeHandler){r.changeHandler=t}else{r=t}if(r.changeHandler==="default"){r.changeHandler=this._oDefaultChangeHandlers[e]}else if(n.indexOf(e)>-1){throw Error("You can't use a custom change handler for the following Developer Mode change types: "+n.toString()+". Please use 'default' instead.")}return r};C.prototype.getChangeHandler=function(e,t,r,n,a){return this._getInstanceSpecificChangeRegistryItem(e,r,n).then(function(r){var n=r||this._getRegistryItem(t,e);if(!n){throw Error("No Change handler registered for the Control and Change type")}if(!this._isRegistryItemValidForLayer(n,a)){throw Error("Change type "+e+" not enabled for layer "+a)}return n.getChangeTypeMetadata().getChangeHandler()}.bind(this))};C.prototype.registerControlForSimpleChange=function(e,t){var r;if(!e){return}if(!t||!t.changeType||!t.changeHandler){return}r=this._createChangeRegistryItemForSimpleChange(e,t);if(r){this.addRegistryItem(r)}};C.prototype._createChangeRegistryItemForSimpleChange=function(e,t){var a;var i;var o;var s;s=Object.assign({},this._oSettings.getDefaultLayerPermissions());var g=t.layers;if(g){Object.keys(g).forEach(function(e){if(s[e]===undefined){throw Error("The Layer '"+e+"' is not supported. Please only use supported layers")}s[e]=g[e]})}a={name:t.changeType,changeHandler:t.changeHandler,layers:s};i=new n(a);a={changeTypeMetadata:i,controlType:e};o=new r(a);return o};C.prototype.addRegistryItem=function(e){var t;var r;if(!e){return}t=e.getChangeTypeName();r=e.getControlType();this._registeredItems[r]=this._registeredItems[r]||{};this._registeredItems[r][t]=e};C.prototype.removeRegistryItem=function(e){if(!e.changeTypeName&&!e.controlType){u.error("sap.ui.fl.registry.ChangeRegistry: ChangeType and/or ControlType required");return}if(e.controlType&&e.changeTypeName){if(this._registeredItems[e.controlType]){if(Object.keys(this._registeredItems[e.controlType]).length===1){delete this._registeredItems[e.controlType]}else{delete this._registeredItems[e.controlType][e.changeTypeName]}}}else if(e.controlType){if(this._registeredItems[e.controlType]){delete this._registeredItems[e.controlType]}}else if(e.changeTypeName){for(var t in this._registeredItems){var r=this._registeredItems[t];delete r[e.changeTypeName]}}};C.prototype._getRegistryItem=function(e,t){var r=this._registeredItems[e];if(r){var n=r[t];if(n){return n}}var a=this._oDefaultActiveChangeHandlers[t];if(a){return a}};C.prototype.initSettings=function(){this._oSettings=a.getInstanceOrUndef();if(!this._oSettings){this._oSettings=new a({})}};C.prototype._isRegistryItemValidForLayer=function(e,t){var r=e.getChangeTypeMetadata().getLayers();return!!r[t]};C.prototype.getDragInfo=function(e){var t=this._registeredItems[e];if(t){return t.getDragInfo()}return null};return C},true);