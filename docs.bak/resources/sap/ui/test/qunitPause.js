/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define("sap/ui/test/qunitPause",[],function(){"use strict";var t={NONE:"none",TIMEOUT:"timeout",ASSERT:"assert"};var e={};var n={pause:[],resume:[]};var i={};var a=false;var u=t.NONE;function r(){return u!==t.NONE}function s(){return u.indexOf(t.ASSERT)>-1}function o(){return QUnit.test.length===2}function f(){var t=window.setTimeout;window.setTimeout=function n(i,a){var u=t.apply(null,arguments);e[u]={delay:a||0,callback:i,startTime:Date.now()};return u}}function c(){var t=o()?"pushResult":"push";var e=QUnit.assert[t];QUnit.assert[t]=function(){var t=this;var n=arguments;var i=o()?arguments[0].result:arguments[0];var a=t.test&&sap.ui.test&&sap.ui.test.Opa&&sap.ui.test.Opa.config.testName===t.test.testName;if(a&&!i&&s()){var u=new sap.ui.test.Opa;var r=true;v();var f=new Promise(function(i){m(function(){if(r){r=false;i()}});e.apply(t,n)});u.iWaitForPromise(f)}else{e.apply(t,n)}}}function l(){if(r()){i=e[QUnit.config.timeout];if(!i){throw new Error("QUnitPause should be loaded before QUnit!")}i.originalCallback=i.callback;i.callback=function(){v();m(function(){var t=Math.max(0,i.delay-(Date.now()-i.startTime));QUnit.config.timeout=setTimeout(i.originalCallback,t)})};clearTimeout(QUnit.config.timeout);QUnit.config.timeout=setTimeout(i.callback,QUnit.config.testTimeout);e={}}}function p(){return T("pause").apply(this,arguments)}function m(){return T("resume").apply(this,arguments)}function v(){if(r()&&!a){a=true;g("pause");clearTimeout(QUnit.config.timeout)}else if(!s()){setTimeout(function(){U()},0)}}function U(){g("resume",true);a=false}function d(e){var n=false;for(var i in t){if(t[i]===e){n=true}}return n}function T(t){return function(e,i,a){n[t].push({cb:e,context:i,args:a,called:false})}}function g(t,e){n[t].forEach(function(t){if(!e||!t.called){t.cb.apply(t.context,t.args);t.called=true}})}return{PAUSE_RULES:t,paused:a,get pauseRule(){return u},set pauseRule(e){var n=e.split(",");u="";var i=n.filter(d).join(",");u=i?i:t.NONE},shouldPause:r,shouldPauseOnAssert:s,setupAfterQUnit:c,setupBeforeQUnit:f,setupBeforeOpaTest:l,onPause:p,onResume:m,emitPause:v,emitResume:U}},true);