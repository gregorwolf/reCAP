/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/DataType","sap/ui/base/ManagedObject","sap/ui/core/CustomData","./mvc/View","./mvc/EventHandlerResolver","./ExtensionPoint","./StashedControlSupport","sap/ui/base/SyncPromise","sap/base/Log","sap/base/util/ObjectPath","sap/base/util/values","sap/base/assert","sap/base/security/encodeXML","sap/base/util/LoaderExtensions","sap/base/util/JSTokenizer","sap/base/util/isEmptyObject"],function(e,t,n,r,i,a,o,s,u,l,f,c,p,d,g,m,v){"use strict";function h(e,r,i,a,o){var s=n.bindingParser(r,a,true,false,false,false,o);if(s&&typeof s==="object"){return s}var u=r=s||r;var f=t.getType(e);if(f){if(f instanceof t){u=f.parseValue(r,{context:a,locals:o});if(!f.isValid(u)){l.error("Value '"+r+"' is not valid for type '"+f.getName()+"'.")}}}else{throw new Error("Property "+i+" has unknown type "+e)}return typeof u==="string"?n.bindingParser.escape(u):u}function w(e){return e.localName||e.baseName||e.nodeName}var b="http://www.w3.org/1999/xhtml";var y="http://www.w3.org/2000/xmlns/";var _="http://www.w3.org/2000/svg";var C="sap.ui.core";var x="http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1";var N="http://schemas.sap.com/sapui5/extension/sap.ui.core.support.Support.info/1";var I="http://schemas.sap.com/sapui5/extension/sap.ui.core.xmlcomposite/1";var A="http://schemas.sap.com/sapui5/extension/sap.ui.core.Internal/1";var M="http://schemas.sap.com/sapui5/preprocessorextension/";function P(e,t){function n(e,n,r,i,a){var o,s,l=[];for(o=e.firstChild;o;o=o.nextSibling){s=t(e,n,r,o,false,i,a);if(s){l.push(s.unwrap())}}return u.resolve(l)}function r(e,n,r,i,a){var o,s=Promise.resolve(),u=[i];for(o=e.firstChild;o;o=o.nextSibling){s=s.then(t.bind(null,e,n,r,o,false,i,a));u.push(s)}return Promise.all(u)}return e?r:n}var V={};V.loadTemplate=function(e,t){var n=e.replace(/\./g,"/")+("."+(t||"view")+".xml");return g.loadResource(n).documentElement};V.loadTemplatePromise=function(e,t){var n=e.replace(/\./g,"/")+("."+(t||"view")+".xml");return g.loadResource(n,{async:true}).then(function(e){return e.documentElement})};V.parseViewAttributes=function(e,t,n){var r=t.getMetadata().getAllProperties();for(var i=0;i<e.attributes.length;i++){var a=e.attributes[i];if(a.name==="controllerName"){t._controllerName=a.value}else if(a.name==="resourceBundleName"){t._resourceBundleName=a.value}else if(a.name==="resourceBundleUrl"){t._resourceBundleUrl=a.value}else if(a.name==="resourceBundleLocale"){t._resourceBundleLocale=a.value}else if(a.name==="resourceBundleAlias"){t._resourceBundleAlias=a.value}else if(a.name==="class"){t.addStyleClass(a.value)}else if(!n[a.name]&&r[a.name]){n[a.name]=h(r[a.name].type,a.value,a.name,t._oContainingView.oController)}}};V.enrichTemplateIds=function(e,t){V.enrichTemplateIdsPromise(e,t,false);return e};V.enrichTemplateIdsPromise=function(e,t,n){return q(e,t,true,n).then(function(){return e})};V.parseTemplate=function(e,t){return V.parseTemplatePromise(e,t,false).unwrap()};V.parseTemplatePromise=function(e,t,n,r){return q(e,t,false,n,r).then(function(){var e=u.resolve(arguments[0]);if(t.isA("sap.ui.core.Fragment")){return e}var r=arguments;if(t.isA("sap.ui.core.mvc.View")&&t._epInfo&&t._epInfo.all.length>0){e=E(n,t,{content:t._epInfo.all})}return e.then(function(){if(Array.isArray(r[0])){r[0]=r[0].filter(function(e){return!e._isExtensionPoint})}return r[0]})})};function R(e){var t,n=/^[a-zA-Z_$][a-zA-Z0-9_$]*$/;if(!e||typeof e!=="object"){t="core:require in XMLView can't be parsed to a valid object"}else{Object.keys(e).some(function(r){if(!n.test(r)){t="core:require in XMLView contains invalid identifier: '"+r+"'";return true}if(!e[r]||typeof e[r]!=="string"){t="core:require in XMLView contains invalide value '"+e[r]+"'under key '"+r+"'";return true}})}return t}function S(e,t){var n=e.getAttributeNS(C,"require"),r,i,a;if(n){try{r=m.parseJS(n)}catch(t){l.error("Require attribute can't be parsed on Node: ",e.nodeName);throw t}a=R(r);if(a){throw new Error(a+" on Node: "+e.nodeName)}if(!v(r)){i={};if(t){return new Promise(function(e,t){var n=Object.keys(r).reduce(function(e,t){i[t]=sap.ui.require(r[t]);return e&&i[t]!==undefined},true);if(n){e(i);return}sap.ui.require(c(r),function(){var t=arguments;Object.keys(r).forEach(function(e,n){i[e]=t[n]});e(i)},t)})}else{Object.keys(r).forEach(function(e){i[e]=sap.ui.requireSync(r[e])});return u.resolve(i)}}}}function E(e,t,n){var r=u.resolve();if(!v(n)){var i=[];var a;if(e){r=new Promise(function(e){a=e})}Object.keys(n).forEach(function(e){var r=n[e];r.forEach(function(e){e.targetControl=t;var n=sap.ui.require(e.providerClass);if(n){i.push(n.applyExtensionPoint(e))}else{var r=new Promise(function(t,n){sap.ui.require([e.providerClass],function(e){t(e)},n)}).then(function(t){return t.applyExtensionPoint(e)});i.push(r)}})});if(e){Promise.all(i).then(a)}}return r}function T(e,t,n){var r=n;for(var i=0;i<100;i++){var a=e.lookupNamespaceURI(r);if(a==null||a===t){return r}r=n+i}throw new Error("Could not find an unused namespace prefix after 100 tries, giving up")}function q(t,c,g,m,R){var q=[],L=T(t,A,"__ui5"),O=S(t,m)||u.resolve();t.setAttributeNS(y,"xmlns:"+L,A);m=m&&c._sProcessingMode==="sequential";l.debug("XML processing mode is "+(m?"sequential":"default"),"","XMLTemplateProcessor");var U=sap.ui.getCore().getConfiguration().getDesignMode();if(U){c._sapui_declarativeSourceInfo={xmlNode:t,xmlRootNode:c._oContainingView===c?t:c._oContainingView._sapui_declarativeSourceInfo.xmlRootNode}}var j=c.sViewName||c._sFragmentName;if(!j){var B=c;var k=0;while(++k<1e3&&B&&B!==B._oContainingView){B=B._oContainingView}j=B.sViewName}if(c.isSubView()){H(t,true,false,O)}else{if(t.localName==="View"&&t.namespaceURI!=="sap.ui.core.mvc"){l.warning("XMLView root node must have the 'sap.ui.core.mvc' namespace, not '"+t.namespaceURI+"'"+(j?" (View name: "+j+")":""))}z(t,false,false,O)}var X=0;function W(){for(;X<q.length;X++){var e=q[X];if(e&&typeof e.then==="function"){return e.then(F).then(W)}}return q}function F(e){var t=[X,1].concat(e);Array.prototype.splice.apply(q,t)}return O.then(W);function D(e){return e}function K(e){return c._oContainingView.createId(e)}function H(e,t,n,r){if(e.nodeType===1){var i=w(e);if(e.namespaceURI===b||e.namespaceURI===_){q.push("<"+i+" ");var a=false;for(var o=0;o<e.attributes.length;o++){var s=e.attributes[o];var u=s.value;if(s.name==="id"){a=true;u=Y(c,e)}q.push(s.name+'="'+d(u)+'" ')}if(t===true){q.push("data-sap-ui-preserve"+'="'+c.getId()+'" ');if(!a){q.push("id"+'="'+c.getId()+'" ')}}q.push(">");var l=e;if(window.HTMLTemplateElement&&e instanceof HTMLTemplateElement&&e.content instanceof DocumentFragment){l=e.content}z(l,false,false,r);q.push("</"+i+">")}else if(i==="FragmentDefinition"&&e.namespaceURI===C){z(e,false,true,r)}else{O=O.then(function(){return Z(e,r).then(function(e){for(var t=0;t<e.length;t++){var n=e[t];if(c.getMetadata().hasAggregation("content")){c._epInfo=c._epInfo||{contentControlsCount:0,last:null,all:[]};if(n._isExtensionPoint){n.index=c._epInfo.contentControlsCount;n.targetControl=c;n.aggregationName="content";if(c._epInfo.last){c._epInfo.last._nextSibling=n}c._epInfo.last=n;c._epInfo.all.push(n)}else{c._epInfo.contentControlsCount++;c.addAggregation("content",n)}}else if(c.getMetadata().hasAssociation("content")){c.addAssociation("content",n)}}return e})});q.push(O)}}else if(e.nodeType===3&&!n){var f=e.textContent||e.text,p=w(e.parentNode);if(f){if(p!="style"){f=d(f)}q.push(f)}}}function z(e,t,n,r){var i=e.childNodes;for(var a=0;a<i.length;a++){H(i[a],t,n,r)}}function J(t,n){var r;var i=sap.ui.getCore().getLoadedLibraries();e.each(i,function(e,i){if(t===i.namespace||t===i.name){r=i.name+"."+(i.tagNames&&i.tagNames[n]||n)}});r=r||t+"."+n;function a(e){if(!e){l.error("Control '"+r+"' did not return a class definition from sap.ui.define.","","XMLTemplateProcessor");e=f.get(r)}if(!e){l.error("Can't find object class '"+r+"' for XML-view","","XMLTemplateProcessor")}return e}var o=r.replace(/\./g,"/");var s=sap.ui.require(o);if(!s){if(m){return new Promise(function(e,t){sap.ui.require([o],function(t){t=a(t);e(t)},t)})}else{s=sap.ui.requireSync(o);s=a(s)}}return s}function $(e,t,n){if(e.namespaceURI===b||e.namespaceURI===_){var r=e.attributes["id"]?e.attributes["id"].textContent||e.attributes["id"].text:null;if(g){return V.enrichTemplateIdsPromise(e,c,m).then(function(){return[]})}else{var i=function(t){var n={id:r?Y(c,e,r):undefined,xmlNode:e,containingView:c._oContainingView,processingMode:c._sProcessingMode};if(c.fnScopedRunWithOwner){return c.fnScopedRunWithOwner(function(){return new t(n)})}return new t(n)};if(m){return new Promise(function(e,t){sap.ui.require(["sap/ui/core/mvc/XMLView"],function(t){e([i(t)])},t)})}else{var a=sap.ui.requireSync("sap/ui/core/mvc/XMLView");return u.resolve([i(a)])}}}else{return Z(e,t,n)}}function Z(e,t,n){if(w(e)==="ExtensionPoint"&&e.namespaceURI===C){if(g){return u.resolve([])}else{var r=c instanceof i?c._oContainingView:c;var a=o._factory.bind(null,r,e.getAttribute("name"),function(){var r=u.resolve();var i=[];var a=e.childNodes;for(var o=0;o<a.length;o++){var s=a[o];if(s.nodeType===1){r=r.then($.bind(null,s,t,n));i.push(r)}}return u.all(i).then(function(e){var t=[];e.forEach(function(e){t=t.concat(e)});return t})});return u.resolve(c.fnScopedRunWithOwner?c.fnScopedRunWithOwner(a):a())}}else{var s=J(e.namespaceURI,w(e));if(s&&typeof s.then==="function"){return s.then(function(r){return G(e,r,t,n)})}else{return G(e,s,t,n)}}}function G(e,t,o,f){var d=e.namespaceURI,b={},y={},_="",T=[],q=null,L=null,O=e.getAttribute("stashed")==="true";if(!g){e.removeAttribute("stashed")}if(!t){return u.resolve([])}var j=t.getMetadata();var B=j.getAllSettings();var k=S(e,m);if(k){o=u.all([o,k]).then(function(e){return Object.assign({},e[0],e[1])})}o=o.then(function(o){if(v(o)){o=null}if(!g){for(var s=0;s<e.attributes.length;s++){var u=e.attributes[s],f=u.name,d=u.namespaceURI,m=B[f],y=u.value;if(f==="id"){b[f]=Y(c,e,y)}else if(f==="class"){_+=y}else if(f==="viewName"){b[f]=y}else if(f==="fragmentName"){b[f]=y;b["containingView"]=c._oContainingView}else if(f==="binding"&&!m||f==="objectBindings"){if(!O){var I=n.bindingParser(y,c._oContainingView.oController);if(I){b.objectBindings=b.objectBindings||{};b.objectBindings[I.model||undefined]=I}}}else if(f==="metadataContexts"){if(!O){var P=null;try{P=V._calculatedModelMapping(y,c._oContainingView.oController,true)}catch(e){l.error(c+":"+e.message)}if(P){b.metadataContexts=P;if(V._preprocessMetadataContexts){V._preprocessMetadataContexts(t.getMetadata().getName(),b,c._oContainingView.oController)}}}}else if(f.indexOf(":")>-1){d=u.namespaceURI;if(d===x){var R=w(u);T.push(new r({key:R,value:h("any",y,R,c._oContainingView.oController)}))}else if(d===N){L=y}else if(d&&d.startsWith(M)){l.debug(c+": XMLView parser ignored preprocessor attribute '"+f+"' (value: '"+y+"')")}else if(d===A&&w(u)==="invisible"){m=B.visible;if(m&&m._iKind===0&&m.type==="boolean"){b.visible=false}}else if(d===C||d===A||f.startsWith("xmlns:")){}else{if(!q){q={}}if(!q.hasOwnProperty(u.namespaceURI)){q[u.namespaceURI]={}}q[u.namespaceURI][w(u)]=u.nodeValue;l.debug(c+": XMLView parser encountered unknown attribute '"+f+"' (value: '"+y+"') with unknown namespace, stored as sap-ui-custom-settings of customData")}}else if(m&&m._iKind===0){b[f]=h(m.type,y,f,c._oContainingView.oController,o)}else if(m&&m._iKind===1&&m.altTypes){if(!O){b[f]=h(m.altTypes[0],y,f,c._oContainingView.oController,o)}}else if(m&&m._iKind===2){if(!O){var I=n.bindingParser(y,c._oContainingView.oController,false,false,false,false,o);if(I){b[f]=I}else{l.error(c+": aggregations with cardinality 0..n only allow binding paths as attribute value (wrong value: "+f+"='"+y+"')")}}}else if(m&&m._iKind===3){if(!O){b[f]=K(y)}}else if(m&&m._iKind===4){if(!O){b[f]=y.split(/[\s,]+/g).filter(D).map(K)}}else if(m&&m._iKind===5){if(!O){var S=[];a.parse(y).forEach(function(e){var t=a.resolveEventHandler(e,c._oContainingView.oController,o);if(t){S.push(t)}else{l.warning(c+': event handler function "'+e+'" is not a function or does not exist in the controller.')}});if(S.length){b[f]=S}}}else if(m&&m._iKind===-1){if(i.prototype.isPrototypeOf(t.prototype)&&f=="async"){b[f]=h(m.type,y,f,c._oContainingView.oController,o)}else{l.warning(c+": setting '"+f+"' for class "+j.getName()+" (value:'"+y+"') is not supported")}}else{p(f==="xmlns",c+": encountered unknown setting '"+f+"' for class "+j.getName()+" (value:'"+y+"')");if(V._supportInfo){V._supportInfo({context:e,env:{caller:"createRegularControls",error:true,info:"unknown setting '"+f+"' for class "+j.getName()}})}}}if(q){T.push(new r({key:"sap-ui-custom-settings",value:q}))}if(T.length>0){b.customData=T}}return o});var X=P(m,W);function W(e,t,n,r,i,a,o){var u,l;if(r.nodeType===1){if(r.namespaceURI===I){b[w(r)]=r.querySelector("*");return}u=r.namespaceURI===d&&n&&n[w(r)];if(u){return X(r,u,false,a,o)}else if(t){if(!i&&r.getAttribute("stashed")==="true"&&!g){var f=r;r=r.cloneNode();f.removeAttribute("stashed");l=function(){var i=Y(c,r);s.createStashedControl({wrapperId:i,fnCreate:function(){var r=m;m=false;try{return W(e,t,n,f,true,a,o).unwrap()}finally{m=r}}})};if(c.fnScopedRunWithOwner){c.fnScopedRunWithOwner(l)}else{l()}r.removeAttribute("visible");Q(r,"invisible")}if(b[t.name]&&b[t.name].path&&typeof b[t.name].path==="string"){o={aggregation:t.name,id:b.id}}return $(r,a,o).then(function(e){for(var n=0;n<e.length;n++){var r=e[n];var i=t.name;if(r._isExtensionPoint){if(!b[i]){b[i]=[]}var a=y[i];if(!a){a=y[i]=[]}r.index=b[i].length;r.aggregationName=i;r.closestAggregationBindingCarrier=o&&o.id;r.closestAggregationBinding=o&&o.aggregation;var s=a[a.length-1];if(s){s._nextSibling=r}a.push(r)}else if(t.multiple){if(!b[i]){b[i]=[]}if(typeof b[i].path==="string"){p(!b[i].template,"list bindings support only a single template object");b[i].template=r}else{b[i].push(r)}}else{p(!b[i],"multiple aggregates defined for aggregation with cardinality 0..1");b[i]=r}}return e})}else if(w(e)!=="FragmentDefinition"||e.namespaceURI!==C){throw new Error("Cannot add direct child without default aggregation defined for control "+j.getElementName())}}else if(r.nodeType===3){var v=r.textContent||r.text;if(v&&v.trim()){throw new Error("Cannot add text nodes as direct child of an aggregation. For adding text to an aggregation, a surrounding html tag is needed: "+v.trim())}}}var F=j.getDefaultAggregation();var H=j.getAllAggregations();return X(e,F,H,o,f).then(function(){var n;var r=u.resolve();var a=u.resolve();var o=e.getAttribute("type");if(g&&e.hasAttribute("id")){ee(c,e)}else if(!g){if(t.getMetadata().isA("sap.ui.core.Fragment")&&o!=="JS"&&c._sProcessingMode==="sequential"){b.processingMode="sequential"}if(t.getMetadata().isA("sap.ui.core.mvc.View")){var s=function(){if(!t._sType&&!b.viewName){b.viewName="module:"+t.getMetadata().getName().replace(/\./g,"/")}if(t.getMetadata().isA("sap.ui.core.mvc.XMLView")&&c._sProcessingMode==="sequential"){b.processingMode="sequential"}return i._legacyCreate(b,undefined,t._sType||o)};if(c.fnScopedRunWithOwner){n=c.fnScopedRunWithOwner(s)}else{n=s()}}else if(t.getMetadata().isA("sap.ui.core.Fragment")&&m){var l="sap/ui/core/Fragment";var f=sap.ui.require(l);b.name=b.name||b.fragmentName;if(f){a=f.load(b)}else{a=new Promise(function(e,t){sap.ui.require([l],function(t){t.load(b).then(function(t){e(t)})},t)})}}else{var p=function(){var e;if(c.fnScopedRunWithOwner){e=c.fnScopedRunWithOwner(function(){var e=new t(b);return e})}else{e=new t(b)}r=E(m,e,y);return e};if(R&&R.fnRunWithPreprocessor){n=R.fnRunWithPreprocessor(p)}else{n=p()}}}return a.then(function(e){return e||n}).then(function(t){if(_&&t.addStyleClass){t.addStyleClass(_)}if(!t){t=[]}else if(!Array.isArray(t)){t=[t]}if(V._supportInfo&&t){for(var n=0,i=t.length;n<i;n++){var a=t[n];if(a&&a.getId()){var o=V._supportInfo({context:e,env:{caller:"createRegularControls",nodeid:e.getAttribute("id"),controlid:a.getId()}}),s=L?L+",":"";s+=o;V._supportInfo.addSupportInfo(a.getId(),s)}}}if(U){t.forEach(function(t){if(j.getCompositeAggregationName){var n=e.getElementsByTagName(t.getMetadata().getCompositeAggregationName());for(var r=0;r<n.length;r++){e.removeChild(n[0])}}t._sapui_declarativeSourceInfo={xmlNode:e,xmlRootNode:c._sapui_declarativeSourceInfo.xmlRootNode,fragmentName:j.getName()==="sap.ui.core.Fragment"?b["fragmentName"]:null}})}return r.then(function(){return t})})})}function Q(e,t){var n=T(e,A,L);e.setAttributeNS(A,n+":"+t,"true")}function Y(e,t,n){if(t.getAttributeNS(A,"id")){return t.getAttribute("id")}else{return K(n?n:t.getAttribute("id"))}}function ee(e,t){t.setAttribute("id",K(t.getAttribute("id")));Q(t,"id")}}V._preprocessMetadataContexts=null;V._calculatedModelMapping=function(e,t,r){var i,a={},o=n.bindingParser(e,t);function s(e){if(e.length%2===0){throw new Error("The last entry is no binding")}for(var t=1;t<=e.length;t=t+2){if(typeof e[t-1]=="string"){throw new Error("Binding expected not a string")}if(e[t]){if(typeof e[t]!="string"||e[t]!=","){throw new Error("Missing delimiter ','")}}}}if(o){if(!o.formatter){i=o;o={parts:[i]}}else{s(o.formatter.textFragments)}for(var u=0;u<o.parts.length;u++){i=o.parts[u];a[i.model]=a[i.model]||(r?[]:null);if(Array.isArray(a[i.model])){a[i.model].push(i)}else{a[i.model]=i}}}return a};return V},true);