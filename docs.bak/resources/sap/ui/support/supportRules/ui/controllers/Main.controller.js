/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/support/supportRules/ui/controllers/BaseController","sap/ui/model/json/JSONModel","sap/ui/support/supportRules/CommunicationBus","sap/ui/support/supportRules/ui/models/SharedModel","sap/ui/support/supportRules/WCBChannels","sap/ui/support/supportRules/Constants","sap/ui/support/supportRules/Storage","sap/ui/thirdparty/URI","sap/ui/support/supportRules/ui/models/Documentation","sap/ui/VersionInfo","sap/m/library"],function(t,e,s,i,o,n,r,a,u,p,d){"use strict";var l=d.ButtonType;return t.extend("sap.ui.support.supportRules.ui.controllers.Main",{onInit:function(){this.model=i;this.getView().setModel(this.model);this.resizeDown();this.setCommunicationSubscriptions();this.initSettingsPopoverModel();this.hidden=false;this.model.setProperty("/hasNoOpener",window.opener?false:true);this.model.setProperty("/constants",n);this.updateShowButton();this._setContextSettings();this._zoomUI();this.bAdditionalViewLoaded=false;s.subscribe(o.UPDATE_SUPPORT_RULES,function(){if(!this.bAdditionalViewLoaded){this.bAdditionalViewLoaded=true;this.loadAdditionalUI()}},this)},_zoomUI:function(){try{var t=window.localStorage.getItem("support-assistant-zoom-ui");var e="100%";switch(t){case"S":e="90%";break;default:}document.querySelector("html").style.fontSize=e}catch(t){}},loadAdditionalUI:function(){this._issuesPage=sap.ui.xmlview(this.getView().getId()+"--issues","sap.ui.support.supportRules.ui.views.Issues");this.byId("navCon").insertPage(this._issuesPage)},onAfterRendering:function(){p.load({library:"sap.ui.core"}).then(function(t){s.publish(o.POST_UI_INFORMATION,{version:t,location:new a(jQuery.sap.getModulePath("sap.ui.support"),window.location.origin+window.location.pathname).toString()})})},initSettingsPopoverModel:function(){var t=new a(sap.ui.resource("sap.ui.support",""),window.location.origin+window.location.pathname)._string,e=sap.ui.version;this.model.setProperty("/supportAssistantOrigin",t);this.model.setProperty("/supportAssistantVersion",e)},copySupportAssistantOriginToClipboard:function(t){var e=this.model.getProperty("/supportAssistantOrigin"),s=function(t){if(t.clipboardData){t.clipboardData.setData("text/plain",e)}else{t.originalEvent.clipboardData.setData("text/plain",e)}t.preventDefault()};if(window.clipboardData){window.clipboardData.setData("text",e)}else{document.addEventListener("copy",s);document.execCommand("copy");document.removeEventListener("copy",s)}},setCommunicationSubscriptions:function(){var t;s.subscribe(o.CURRENT_LOADING_PROGRESS,function(e){var s=e.value,i=this.byId("progressIndicator");if(e.value<100){this.model.setProperty("/showProgressIndicator",true);clearTimeout(t);t=setTimeout(function(){this.model.setProperty("/showProgressIndicator",false)}.bind(this),2500)}else{setTimeout(function(){this.model.setProperty("/showProgressIndicator",false)}.bind(this),2e3)}i.setDisplayValue(n.RULESET_LOADING+" "+s+"%");this.model.setProperty("/progress",s)},this);s.subscribe(o.ON_ANALYZE_FINISH,function(t){this._clearProcessIndicator();this.ensureOpened();this.model.setProperty("/showProgressIndicator",false);this.model.setProperty("/coreStateChanged",false);this.model.setProperty("/lastAnalysisElapsedTime",t.elapsedTime);this.goToIssues();this.model.setProperty("/analyzedFinish",true)},this);s.subscribe(o.ON_PROGRESS_UPDATE,function(t){var e=t.currentProgress,s=this.byId("progressIndicator");s.setDisplayValue(e+"/"+100);this.model.setProperty("/progress",e)},this);s.subscribe(o.ON_CORE_STATE_CHANGE,function(){this.model.setProperty("/coreStateChanged",true)},this)},resizeUp:function(){s.publish(o.RESIZE_FRAME,{bigger:true})},ensureOpened:function(){s.publish(o.ENSURE_FRAME_OPENED)},resizeDown:function(){s.publish(o.RESIZE_FRAME,{bigger:false})},onSettings:function(t){s.publish(o.ENSURE_FRAME_OPENED);if(!this._settingsPopover){this._settingsPopover=sap.ui.xmlfragment("sap.ui.support.supportRules.ui.views.StorageSettings",this);this.getView().addDependent(this._settingsPopover)}var e=this,i=t.getSource();setTimeout(function(){e._settingsPopover.openBy(i)})},goToAnalysis:function(t){this._setActiveView("analysis")},goToIssues:function(t){this._setActiveView("issues")},goToWiki:function(){u.openTopic("57ccd7d7103640e3a187ed55e1d2c163")},updateShowButton:function(){this.byId("sapSTShowButtonBar").setVisible(this.hidden)},toggleHide:function(){this.hidden=!this.hidden;this.updateShowButton();s.publish(o.TOGGLE_FRAME_HIDDEN,this.hidden)},_clearProcessIndicator:function(){var t=this.byId("progressIndicator");t.setDisplayValue("None");this.model.setProperty("/progress",.1)},_setContextSettings:function(){var t=r.readPersistenceCookie(n.COOKIE_NAME);if(t){this.model.setProperty("/persistingSettings",true);var e=r.getSelectedContext();if(e){this.model.setProperty("/analyzeContext",e.analyzeContext);this.model.setProperty("/subtreeExecutionContextId",e.subtreeExecutionContextId)}else{this.model.setProperty("/analyzeContext",this.model.getProperty("/analyzeContext"));this.model.setProperty("/subtreeExecutionContextId","")}}},_setActiveView:function(t){this.byId("issuesBtn").setType(l.Default);this.byId("analysisBtn").setType(l.Default);this.byId(t+"Btn").setType(l.Emphasized);this.byId("navCon").to(this.byId(t),"show");this.ensureOpened()}})});