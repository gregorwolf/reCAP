/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/deepExtend","sap/ui/support/supportRules/ui/controllers/BaseController","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/ui/support/supportRules/CommunicationBus","sap/ui/support/supportRules/WCBChannels","sap/ui/support/supportRules/ui/models/SharedModel","sap/ui/support/supportRules/RuleSerializer","sap/ui/support/supportRules/Constants","sap/ui/support/supportRules/Storage","sap/ui/support/supportRules/ui/models/SelectionUtils","sap/ui/support/supportRules/ui/controllers/PresetsController","sap/ui/support/supportRules/ui/models/PresetsUtils","sap/ui/support/supportRules/ui/models/CustomJSONListSelection"],function(deepExtend,BaseController,JSONModel,MessageToast,CommunicationBus,channelNames,SharedModel,RuleSerializer,Constants,Storage,SelectionUtils,PresetsController,PresetsUtils,CustomJSONListSelection){"use strict";return BaseController.extend("sap.ui.support.supportRules.ui.controllers.Analysis",{onInit:function(){this.model=SharedModel;this.setCommunicationSubscriptions();this.tempRulesLoaded=false;this.getView().setModel(this.model);this.treeTable=SelectionUtils.treeTable=this.byId("ruleList");this._oRuleSetsModel=new JSONModel;this.treeTable.setModel(this._oRuleSetsModel,"ruleSets");this.ruleSetView=this.byId("ruleSetsView");this.rulesViewContainer=this.byId("rulesNavContainer");this.bAdditionalViewLoaded=false;this.bAdditionalRulesetsLoaded=false;this.oApplicationinfo={};new CustomJSONListSelection(this.treeTable,true,"id");CommunicationBus.subscribe(channelNames.UPDATE_SUPPORT_RULES,function(){if(!this.bAdditionalViewLoaded){CommunicationBus.publish(channelNames.RESIZE_FRAME,{bigger:true});this.bAdditionalViewLoaded=true;this.loadAdditionalUI()}},this);if(this.model.getProperty("/persistingSettings")){var e=Storage.getVisibleColumns()||[];if(e.length){this.setColumnVisibility(e,true)}}this.byId("presetVariant").addEventDelegate({onclick:this.onPresetVariantClick.bind(this)});this.treeTable.attachEvent("rowSelectionChange",function(e){if(e.getParameter("userInteraction")){PresetsUtils.syncCurrentSelectionPreset(SelectionUtils.getSelectedRules())}})},loadAdditionalUI:function(){this._ruleDetails=sap.ui.xmlfragment("sap.ui.support.supportRules.ui.views.RuleDetails",this);this.byId("rulesDisplayPage").addContentArea(this._ruleDetails);this._ruleCreateUpdatePages=sap.ui.xmlfragment("sap.ui.support.supportRules.ui.views.RuleUpdate",this);this._ruleCreateUpdatePages.forEach(function(e){this.byId("rulesNavContainer").insertPage(e)},this);this._updateRuleList()},onAfterRendering:function(){var e=function(){CommunicationBus.publish(channelNames.ON_INIT_ANALYSIS_CTRL);sap.ui.getCore().detachThemeChanged(e)};if(sap.ui.getCore().isThemeApplied()){CommunicationBus.publish(channelNames.ON_INIT_ANALYSIS_CTRL)}else{sap.ui.getCore().attachThemeChanged(e)}},onAsyncSwitch:function(e){var t=e.getSource();if(e.getParameter("selected")){var i=t.getCustomData()[0].getValue()==="true";var s=t.getProperty("groupName")==="asyncContext"?"/newRule":"/editRule";this.model.setProperty(s+"/async",i);this._updateCheckFunction(s,i)}},_updateCheckFunction:function(e,t){var i=this.model.getProperty(e+"/check");if(!i){return}var s=i.match(/function[^(]*\(([^)]*)\)/);if(!s){return}var o=s[1].trim().split(/\W+/);o[0]=o[0]||"oIssueManager";o[1]=o[1]||"oCoreFacade";o[2]=o[2]||"oScope";if(t){o[3]=o[3]||"fnResolve"}else{o=o.slice(0,3)}var r=i.replace(/function[^(]*\(([^)]*)\)/,"function ("+o.join(", ")+")");this.model.setProperty(e+"/check",r)},getTemporaryLib:function(){var e=this.model.getProperty("/libraries");for(var t=0;t<e.length;t++){if(e[t].title==Constants.TEMP_RULESETS_NAME){return deepExtend({},e[t])}}},setTemporaryLib:function(e){var t=this.model.getProperty("/libraries");for(var i=0;i<t.length;i++){if(t[i].title==Constants.TEMP_RULESETS_NAME){this.model.setProperty("/libraries/"+i,e);return}}},setCommunicationSubscriptions:function(){CommunicationBus.subscribe(channelNames.UPDATE_SUPPORT_RULES,this.updatesupportRules,this);CommunicationBus.subscribe(channelNames.VERIFY_RULE_CREATE_RESULT,function(e){var t=e.result,i=RuleSerializer.deserialize(e.newRule,true),s=this.getTemporaryLib();if(t=="success"){s.rules.push(i);this.setTemporaryLib(s);this._applyTempRulesSelection(s);PresetsUtils.syncCurrentSelectionPreset(SelectionUtils.getSelectedRules());if(Storage.readPersistenceCookie(Constants.COOKIE_NAME)){SelectionUtils.persistSelection();Storage.setRules(s.rules);if(this.showRuleCreatedToast){MessageToast.show('Your temporary rule "'+i.id+'" was persisted in the local storage');this.showRuleCreatedToast=false}}var o=this.model.getProperty("/newEmptyRule");this.model.setProperty("/newRule",deepExtend({},o));this.goToRuleProperties();this.model.setProperty("/selectedRule",i);this._updateRuleList();this.treeTable.updateSelectionFromModel()}else{MessageToast.show("Add rule failed because: "+t)}},this);CommunicationBus.subscribe(channelNames.VERIFY_RULE_UPDATE_RESULT,function(e){var t=e.result,i=RuleSerializer.deserialize(e.updateRule,true),s=this;if(t==="success"){var o=this.model.getProperty("/editRuleSource"),r=this._oRuleSetsModel.getData(),n=this.model.getProperty("/libraries");n.forEach(function(e,t){if(e.title===Constants.TEMP_RULESETS_NAME){e.rules.forEach(function(t,r){if(t.id===o.id){e.rules[r]=i;if(s.model.getProperty("/persistingSettings")){Storage.setRules(e.rules)}}});s._syncTreeTableVieModelTempRule(i,r)}});this._oRuleSetsModel.setData(r);this.model.setProperty("/selectedRule",i);SelectionUtils.getSelectedRules();this.treeTable.updateSelectionFromModel();this.goToRuleProperties()}else{MessageToast.show("Update rule failed because: "+t)}},this);CommunicationBus.subscribe(channelNames.POST_AVAILABLE_LIBRARIES,function(e){this.bAdditionalRulesetsLoaded=true;this.model.setProperty("/availableLibrariesSet",e.libNames);this.rulesViewContainer.setBusy(false)},this);CommunicationBus.subscribe(channelNames.POST_APPLICATION_INFORMATION,function(e){this.oApplicationinfo=e},this);CommunicationBus.subscribe(channelNames.POST_AVAILABLE_COMPONENTS,function(e){var t=[],i=this.model.getProperty("/executionScopeComponents"),s=Storage.getSelectedScopeComponents(),o;for(var r=0;r<e.length;r+=1){t.push({text:e[r]})}if(i&&i.length>0){for(o=0;o<t.length;o++){t[o].selected=this.checkIfComponentIsSelected(t[o],i)}}else if(s&&s.length>0){for(o=0;o<t.length;o++){t[o].selected=this.checkIfComponentIsSelected(t[o],s)}}this.model.setProperty("/executionScopeComponents",t)},this);CommunicationBus.subscribe(channelNames.GET_RULES_MODEL,function(e){var t=Storage.readPersistenceCookie(Constants.COOKIE_NAME),i=this.model.getProperty("/loadingAdditionalRuleSets");if(i){SelectionUtils._syncSelectionAdditionalRuleSetsMainModel(e,this._oRuleSetsModel.getData());SelectionUtils._deselectAdditionalRuleSets(e,this.model.getProperty("/namesOfLoadedAdditionalRuleSets"))}if(t){this.initializeTempRules();var s=SelectionUtils.updateSelectedRulesFromLocalStorage(e);if(s){e=s}PresetsUtils.loadCustomPresets()}this._oRuleSetsModel.setData(e);if(t||i){this.treeTable.updateSelectionFromModel()}else{this.treeTable.selectAll()}this.model.setProperty("/selectedRulesCount",SelectionUtils.getSelectedRules().length);PresetsUtils.initializeSelectionPresets(SelectionUtils.getSelectedRules())},this);CommunicationBus.subscribe(channelNames.POST_MESSAGE,function(e){MessageToast.show(e.message)},this);CommunicationBus.subscribe(channelNames.ON_ANALYZE_STARTED,function(e){this.model.setProperty("/showProgressIndicator",true)},this)},checkIfComponentIsSelected:function(e,t){for(var i=0;i<t.length;i+=1){if(t[i].text==e.text&&t[i].selected){return true}}return false},onAnalyze:function(){var e=this.model.getProperty("/selectionPresetsCurrent"),t=this._getExecutionContext();if(!e.selections.length>0){MessageToast.show("Select some rules to be analyzed.");return}if(t.type==="components"&&t.components.length===0){MessageToast.show("Please select some components to be analyzed.");return}CommunicationBus.publish(channelNames.ON_ANALYZE_REQUEST,{rulePreset:e,executionContext:t})},_getExecutionContext:function(){var e={type:this.model.getProperty("/analyzeContext/key")};if(e.type==="subtree"){e.parentId=this.model.getProperty("/subtreeExecutionContextId")}if(e.type==="components"){var t=sap.ui.getCore().byId("componentsSelectionContainer"),i=t.getContent();e.components=[];i.forEach(function(t){if(t.getSelected()){e.components.push(t.getText())}})}return e},onSelectedRuleSets:function(e){var t=true,i=this.model.getProperty("/selectedRule"),s=e.getParameter("selectedKey")==="additionalRulesets";if(s||!i){t=false}if(!this.bAdditionalRulesetsLoaded&&s){this.rulesViewContainer.setBusyIndicatorDelay(0);this.rulesViewContainer.setBusy(true);CommunicationBus.publish(channelNames.GET_NON_LOADED_RULE_SETS,{loadedRulesets:this._getLoadedRulesets()})}this.getView().getModel().setProperty("/showRuleProperties",t)},_getLoadedRulesets:function(){var e=this.treeTable.getModel("ruleSets").getData(),t=[];Object.keys(e).forEach(function(i){var s=e[i].name;if(s&&s!=="temporary"){t.push(s)}});return t},_applyTempRulesSelection:function(e){var t=deepExtend({},this._oRuleSetsModel.getData()),i,s,o,r,n,l,a=function(e){return e.id===s.id};for(var u in t){i=t[u];o=t[u].nodes;if(i.name!==Constants.TEMP_RULESETS_NAME){continue}t[u].nodes=[];for(var c in e.rules){s=e.rules[c];r=o[c]!==undefined?o[c].selected:true;if(this.tempRulesFromStorage){n=this.tempRulesFromStorage.filter(a);if(n.length>0){r=n[0].selected;l=this.tempRulesFromStorage.indexOf(n[0]);this.tempRulesFromStorage.splice(l,1);if(r===false){i.selected=false}}if(this.tempRulesFromStorage.length===0){this.tempRulesFromStorage.length=null}}i.nodes.push({name:s.title,description:s.description,id:s.id,audiences:s.audiences.toString(),categories:s.categories.toString(),minversion:s.minversion,resolution:s.resolution,title:s.title,selected:r,libName:i.name,check:s.check})}}this._oRuleSetsModel.setData(t)},_syncTreeTableVieModelTempRule:function(e,t){var i=this.model.getProperty("/editRuleSource");for(var s in t){if(t[s].name===Constants.TEMP_RULESETS_NAME){for(var o in t[s].nodes){if(t[s].nodes[o].id===i.id){t[s].nodes[o]={name:e.title,description:e.description,id:e.id,audiences:e.audiences,categories:e.categories,minversion:e.minversion,resolution:e.resolution,selected:t[s].nodes[o].selected,title:e.title,libName:t[s].name,check:e.check}}}}}},_hasSelectedComponent:function(){var e=sap.ui.getCore().byId("componentsSelectionContainer").getContent();function t(e){return e.getSelected()}return e.some(t)},onAnalyzeSettings:function(e){CommunicationBus.publish(channelNames.GET_AVAILABLE_COMPONENTS);if(!this._settingsPopover){this._settingsPopover=sap.ui.xmlfragment("sap.ui.support.supportRules.ui.views.AnalyzeSettings",this);this.getView().addDependent(this._settingsPopover)}this._settingsPopover.openBy(e.getSource())},onContextSelect:function(e){if(e.getParameter("selected")){var t=e.getSource(),i=t.getCustomData()[0].getValue(),s=this.model.getProperty("/executionScopes")[i];if(i==="components"&&!this._hasSelectedComponent()){var o=sap.ui.getCore().byId("componentsSelectionContainer").getContent();if(o.length>0){o[0].setSelected(true);this.onScopeComponentSelect(null)}}this.model.setProperty("/analyzeContext",s)}if(Storage.readPersistenceCookie(Constants.COOKIE_NAME)){this.persistExecutionScope()}},onExecutionContextChange:function(e){var t=e.getSource().getValue();if(t){this.model.setProperty("/subtreeExecutionContextId",t)}if(Storage.readPersistenceCookie(Constants.COOKIE_NAME)){this.persistExecutionScope()}},onScopeComponentSelect:function(e){var t=this.model.getProperty("/executionScopeComponents");if(Storage.readPersistenceCookie(Constants.COOKIE_NAME)){Storage.setSelectedScopeComponents(t)}},onBeforePopoverOpen:function(){if(this.model.getProperty("/executionScopeComponents").length===0){CommunicationBus.publish(channelNames.GET_AVAILABLE_COMPONENTS)}},createNewRulePress:function(e){var t=this.model.getProperty("/newEmptyRule");this.model.setProperty("/selectedSetPreviewKey","availableRules");this.model.setProperty("/newRule",deepExtend({},t));this.model.setProperty("/tempLink",{href:"",text:""});this.goToCreateRule()},goToRuleProperties:function(){var e=this.byId("rulesNavContainer");e.to(this.byId("rulesDisplayPage"),"show")},createRuleString:function(e){if(!e){return""}var t="{\n",i=0,s=Object.keys(e).length;for(var o in e){var r=e[o];i++;t+="\t";t+=o+": ";if(o==="check"){t+=r.split("\n").join("\n\t")}else{t+=JSON.stringify(r)}if(i<s){t+=","}t+="\n"}t+="}";return t},updateRule:function(){var e=this.model.getProperty("/editRuleSource/id"),t=this.model.getProperty("/editRule");if(this.checkFunctionString(t.check)){CommunicationBus.publish(channelNames.VERIFY_UPDATE_RULE,{oldId:e,updateObj:RuleSerializer.serialize(t)})}},updatesupportRules:function(e){e=RuleSerializer.deserialize(e.sRuleSet);CommunicationBus.publish(channelNames.REQUEST_RULES_MODEL,e);var t=[],i=this;for(var s in e){var o=[],r=e[s].ruleset._mRules;for(var n in r){var l=r[n];l.libName=s;l.selected=true;o.push(l)}t.push({title:s,type:"library",rules:o,selected:true})}var a;if(t[0].rules[0]){a=t[0].rules[0]}else{a=t[1].rules[0]}i.placeTemporaryRulesetAtStart(t);i.model.setProperty("/selectedRuleStringify","");i.model.setProperty("/selectedRule",a);i.model.setProperty("/selectedRuleStringify",i.createRuleString(a));i.model.setProperty("/libraries",t);var u=i.model.getProperty("/loadingAdditionalRuleSets");if(u){MessageToast.show("Additional rule set(s) loaded!");this.ruleSetView.setSelectedKey("availableRules")}},initializeTempRules:function(){var e=Storage.getRules(),t=this.model.getProperty("/loadingAdditionalRuleSets");if(e&&!t&&!this.tempRulesLoaded){this.tempRulesFromStorage=e;this.tempRulesLoaded=true;e.forEach(function(e){CommunicationBus.publish(channelNames.VERIFY_CREATE_RULE,RuleSerializer.serialize(e))});this.persistedTempRulesCount=e.length}},placeTemporaryRulesetAtStart:function(e){for(var t=0;t<e.length;t++){var i=e[t];if(i.title===Constants.TEMP_RULESETS_NAME){var s=i;e.splice(t,1);e.unshift(s);return}}},addLinkToRule:function(e){var t=this.model.getProperty("/tempLink"),i=deepExtend({},t),s=e.getSource().getProperty("text"),o=s==="Add"?"/newRule":"/editRule",r=this.model.getProperty(o+"/resolutionurls");if(r){r.push(i)}else{this.model.setProperty(o+"/resolutionurls","");r.push(i)}this.model.setProperty("/tempLink",{href:"",text:""})},goToCreateRule:function(){var e=this.byId("rulesNavContainer");e.to(sap.ui.getCore().byId("rulesCreatePage"),"show")},checkFunctionString:function(functionString){try{eval("var testAsignedVar = "+functionString)}catch(e){MessageToast.show("Your check function contains errors, and can't be evaluated:"+e);return false}return true},addNewRule:function(){var e=this.model.getProperty("/newRule");if(this.checkFunctionString(e.check)){this.showRuleCreatedToast=true;CommunicationBus.publish(channelNames.VERIFY_CREATE_RULE,RuleSerializer.serialize(e))}},rulesToolbarITHSelect:function(e){if(e.getParameter("key")==="jsonOutput"){var t=this.model.getProperty("/newRule"),i=this.createRuleString(t);this.model.setProperty("/newRuleStringified",i)}},rulesToolbarEditITHSelect:function(e){if(e.getParameter("key")==="jsonOutput"){var t=this.model.getProperty("/editRule"),i=this.createRuleString(t);this.model.setProperty("/updateRuleStringified",i)}},loadMarkedSupportLibraries:function(){var e=this.byId("availableLibrariesSet"),t=[],i=this.model.getProperty("/availableLibrariesSet");t=e.getSelectedItems().map(function(e){return e.getTitle()});e.getItems().forEach(function(e){e.setSelected(false)});if(t.length>0){i=i.filter(function(e){return t.indexOf(e)<0});this.model.setProperty("/availableLibrariesSet",i);this.model.setProperty("/namesOfLoadedAdditionalRuleSets",t);CommunicationBus.publish(channelNames.LOAD_RULESETS,{aLibNames:{publicRules:t,internalRules:t}});this.model.setProperty("/loadingAdditionalRuleSets",true);this.model.setProperty("/showRuleProperties",true)}else{MessageToast.show("Select additional RuleSet to be loaded.")}},onCellClick:function(e){if(e.getParameter("rowBindingContext")){var t=e.getParameter("rowBindingContext").getObject(),i,s="",o=false;if(t.id&&t.type!=="lib"){i=this.getMainModelFromTreeViewModel(t);s=this.createRuleString(i);o=true}this.model.setProperty("/selectedRuleStringify",s);this.model.setProperty("/selectedRule",i);this.model.setProperty("/showRuleProperties",o)}},getMainModelFromTreeViewModel:function(e){var t=this.model.getProperty("/libraries"),i=null;t.forEach(function(s,o){t[o].rules.forEach(function(t){if(e.id===t.id){i=t}})});return i},_generateRuleId:function(e){var t=0,i=this.getTemporaryLib(),s=i.rules,o,r=function(i){return i.id===e+t};while(++t){o=s.some(r);if(!o){return e+t}}},duplicateRule:function(e){var t=e.getSource().getBindingContext("ruleSets").getPath(),i=this.treeTable.getBinding().getModel().getProperty(t),s=this.getMainModelFromTreeViewModel(i),o=deepExtend({},s);o.id=this._generateRuleId(o.id);this.model.setProperty("/newRule",o);this.goToCreateRule()},editRule:function(e){var t=e.getSource().getBindingContext("ruleSets").getPath(),i=this.treeTable.getBinding().getModel().getProperty(t),s=this.getMainModelFromTreeViewModel(i);this.model.setProperty("/editRuleSource",s);this.model.setProperty("/editRule",deepExtend({},s));var o=this.byId("rulesNavContainer");o.to(sap.ui.getCore().byId("ruleUpdatePage"),"show")},deleteTemporaryRule:function(e){var t=this.getObjectOnTreeRow(e),i=deepExtend({},this._oRuleSetsModel.getData()),s=this.model.getProperty("/libraries"),o;s.forEach(function(e){if(e.title===Constants.TEMP_RULESETS_NAME){o=e.rules.filter(function(e){return e.id!==t.id});e.rules=o}});for(var r in i){if(i[r].name===Constants.TEMP_RULESETS_NAME){for(var n in i[r].nodes){if(i[r].nodes[n].id===t.id){i[r].nodes.splice(n,1)}}}}this._oRuleSetsModel.setData(i);CommunicationBus.publish(channelNames.DELETE_RULE,RuleSerializer.serialize(t));this._updateRuleList();PresetsUtils.syncCurrentSelectionPreset(SelectionUtils.getSelectedRules());if(Storage.readPersistenceCookie(Constants.COOKIE_NAME)){Storage.removeSelectedRules(o);SelectionUtils.persistSelection()}},getObjectOnTreeRow:function(e){var t=e.getSource().getBindingContext("ruleSets").getPath(),i=this.treeTable.getBinding().getModel().getProperty(t),s=this.model.getProperty("/libraries");s.forEach(function(e,t){e.rules.forEach(function(e){if(e.id===i.id){i.check=e.check}})});return i},_updateRuleList:function(){var e=this.getView().byId("ruleList"),t=this.getTemporaryLib()["rules"];if(!t.length){e.setRowActionCount(1)}else{e.setRowActionCount(2)}},setColumnVisibility:function(e,t){var i=this.treeTable.getColumns();i.forEach(function(i){i.setVisible(!t);e.forEach(function(e){if(i.sId.includes(e)){i.setVisible(t)}})})},onColumnVisibilityChange:function(e){var t=e.getParameter("column"),i=e.getParameter("newVisible");if(!this.model.getProperty("/persistingSettings")){return}t.setVisible(i);this.persistVisibleColumns()},onPresetVariantClick:function(){if(!this._PresetsController){this._PresetsController=new PresetsController(this.model,this.getView())}this._PresetsController.openPresetVariant()}})});