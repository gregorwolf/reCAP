/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/apply/_internal/ChangesController","sap/ui/fl/write/_internal/flexState/compVariants/CompVariantState","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/LayerUtils","sap/ui/fl/apply/_internal/flexState/compVariants/Utils","sap/ui/fl/Utils"],function(e,t,r,n,a,o,i,l,c){"use strict";var s={};function f(e){e.reference=r.getFlexReferenceForControl(e.selector);return t.initialize({componentId:e.componentId||c.getAppComponentForControl(e.selector).getId(),reference:e.reference,componentData:{},manifest:{}})}function p(e){var r=t.getCompVariantsMap(e.reference);var n=[];for(var a in r){var o=r[a];for(var l in o.byId){n.push(o.byId[l])}}return i.filterChangeOrChangeDefinitionsByCurrentLayer(n,e.currentLayer)}function u(e){var t=r.getFlexReferenceForControl(e.selector);return a.persistAll(t)}function C(e){if(!e.reference){var t=n.getAppComponentForSelector(e.selector);e.reference=r.getFlexReferenceForControl(t)}return o.getChangePersistenceForComponent(e.reference)}function g(t){var r=C(t);return r.getChangesForComponent(e(t,["invalidateCache","selector"]),t.invalidateCache).then(function(e){var n=[];if(t.includeDirtyChanges){n=r.getDirtyChanges()}return e.concat(n)})}function v(e,t){var r=n.getFlexControllerInstance(e.selector);var a=n.getDescriptorFlexControllerInstance(e.selector);return r.saveAll(t,e.skipUpdateCache,e.draft).then(a.saveAll.bind(a,t,e.skipUpdateCache,e.draft))}s.getFlexObjects=function(e){return f(e).then(function(){var t=p(e);var r=g(e);return Promise.all([t,r]).then(function(e){return e[0].concat(e[1])})})};s.saveFlexObjects=function(t){var r=n.getAppComponentForSelector(t.selector);return Promise.all([u(t),v(t,r)]).then(function(){if(t.layer){t.currentLayer=t.layer}t.componentId=r.getId();t.invalidateCache=true;return s.getFlexObjects(e(t,"skipUpdateCache"))})};return s});